<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Acessos - Scarparo</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-black-rich: #121212; --color-white-bg: #F4F6F9; --color-white-pure: #FFFFFF;
            --color-gold-matte: #B9965B; --color-text-dark: #333333; --color-text-gray: #757575;
            --color-success: #27AE60; --color-danger: #E74C3C; --color-gray-border: #E0E0E0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--color-white-bg); padding: 2rem; font-size: 0.95rem; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-shrink: 0; }
        .title h2 { font-size: 1.6rem; font-weight: 700; color: var(--color-black-rich); margin: 0; }
        .title p { color: var(--color-text-gray); margin: 0; font-size: 0.9rem; }

        /* Botão Novo Usuário */
        .btn-new { 
            background-color: var(--color-gold-matte); color: #121212; border: none; 
            padding: 0.8rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; 
            transition: 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(185, 150, 91, 0.2);
        }
        .btn-new:hover { transform: translateY(-2px); background-color: #a3844a; }

        /* Barra de Pesquisa */
        .search-box { 
            background: var(--color-white-pure); padding: 1rem; border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 1.5rem; flex-shrink: 0;
        }
        .search-input { 
            width: 100%; padding: 0.8rem; border: 1px solid var(--color-gray-border); 
            border-radius: 6px; outline: none; font-size: 1rem;
        }
        .search-input:focus { border-color: var(--color-gold-matte); }

        /* Lista de Usuários */
        .user-list-container { flex: 1; overflow-y: auto; background: var(--color-white-pure); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .user-list { list-style: none; }
        .user-item { 
            display: flex; align-items: center; padding: 1.2rem 2rem; border-bottom: 1px solid #f0f0f0; 
            cursor: pointer; transition: 0.2s; 
        }
        .user-item:hover { background-color: #fafafa; }
        .user-item:last-child { border-bottom: none; }

        .avatar { 
            width: 45px; height: 45px; background-color: var(--color-black-rich); color: var(--color-gold-matte); 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 1.1rem; margin-right: 1rem; flex-shrink: 0;
        }
        .info { flex: 1; }
        .info h3 { margin: 0; font-size: 1rem; color: var(--color-text-dark); font-weight: 600; }
        .info span { font-size: 0.85rem; color: var(--color-text-gray); }
        .role-badge { 
            padding: 4px 10px; background: #f0f0f0; border-radius: 20px; 
            font-size: 0.75rem; color: #666; font-weight: 600; text-transform: uppercase; 
        }
        .arrow-icon { color: #ccc; margin-left: 1rem; }

        /* --- MODAIS --- */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px); }
        .modal-container { 
            background: var(--color-white-pure); padding: 2rem; border-radius: 12px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; position: absolute; 
            top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; 
            z-index: 1000; border: 1px solid var(--color-gray-border); 
        }
        
        .modal-header { display: flex; align-items: center; gap: 15px; margin-bottom: 2rem; border-bottom: 1px solid #eee; padding-bottom: 1rem; }
        .modal-avatar { width: 60px; height: 60px; background-color: var(--color-gold-matte); color: #000; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 1.5rem; }
        .modal-title h3 { margin: 0; color: var(--color-black-rich); }
        .modal-title p { margin: 0; color: var(--color-text-gray); font-size: 0.9rem; }

        /* Seção de Credenciais (Editável) */
        .credentials-box { background: #FAFAFA; padding: 1rem; border-radius: 8px; border: 1px solid #eee; margin-bottom: 1.5rem; }
        
        .cred-row { display: flex; flex-direction: column; margin-bottom: 1rem; }
        .cred-row:last-child { margin-bottom: 0; }
        
        .cred-label { font-weight: 600; font-size: 0.85rem; color: var(--color-text-gray); margin-bottom: 5px; }
        
        .cred-input-wrapper { display: flex; align-items: center; gap: 8px; width: 100%; }
        
        /* Input Flexível (Resolve o problema de corte) */
        .cred-value { 
            flex: 1; 
            min-width: 0; /* Permite encolher */
            font-family: monospace; 
            font-size: 1rem; 
            color: var(--color-text-dark); 
            letter-spacing: 1px;
            padding: 8px;
            border: 1px solid var(--color-gray-border);
            border-radius: 6px;
            background: #fff;
            outline: none;
        }
        .cred-value:focus { border-color: var(--color-gold-matte); }

        .btn-toggle-pass { background: none; border: none; cursor: pointer; color: var(--color-gold-matte); display: flex; align-items: center; padding: 5px; }

        /* Lista de Permissões */
        .permissions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .perm-item { 
            display: flex; align-items: center; gap: 10px; 
            padding: 10px; border: 1px solid var(--color-gray-border); border-radius: 6px; 
            cursor: pointer; transition: 0.2s; 
        }
        .perm-item:hover { border-color: var(--color-gold-matte); background-color: #fffbf5; }
        .perm-item input[type="checkbox"] { accent-color: var(--color-gold-matte); transform: scale(1.2); cursor: pointer; }
        .perm-label { font-size: 0.9rem; color: var(--color-text-dark); flex: 1; cursor: pointer; user-select: none; }

        .modal-footer { margin-top: 2rem; display: flex; justify-content: space-between; align-items: center; }
        .btn-delete-user { background: transparent; border: 1px solid #f5c6cb; color: var(--color-danger); padding: 0.8rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-delete-user:hover { background: #FDEDEC; }
        
        .footer-actions { display: flex; gap: 10px; }
        .btn-cancel { background: #eee; color: #333; border: none; padding: 0.8rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-save { background: var(--color-gold-matte); color: #121212; border: none; padding: 0.8rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-save:hover { background-color: #a3844a; }

        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { padding: 15px 25px; border-radius: 8px; color: white; background: var(--color-success); box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease; margin-bottom: 10px; }
        .toast.error { background: var(--color-danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Campos do Form de Criação */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: var(--color-text-dark); }
        .form-control { width: 100%; padding: 0.8rem; border: 1px solid var(--color-gray-border); border-radius: 6px; outline: none; font-size: 0.95rem; background: #fafafa; }
        .form-control:focus { border-color: var(--color-gold-matte); background: #fff; }

    </style>
</head>
<body>

    <div id="modal-overlay" class="overlay"></div>
    <div id="toast-container"></div>

    <div class="header">
        <div class="title">
            <div style="display:flex; align-items:center; gap:10px;">
                <img src="logo.png" alt="Logo" style="width:35px; height:auto;">
                <div>
                    <h2>Gestão de Acessos</h2>
                    <p>Controle de usuários, senhas e permissões.</p>
                </div>
            </div>
        </div>
        <button class="btn-new" onclick="openCreateModal()">
            <span style="font-size:1.2rem;">+</span> Novo Usuário
        </button>
    </div>

    <div class="search-box">
        <input type="text" id="search-input" class="search-input" placeholder="Pesquisar usuário..." onkeyup="renderList()">
    </div>

    <div class="user-list-container">
        <ul class="user-list" id="user-list">
            </ul>
    </div>

    <div id="user-modal" class="modal-container">
        <input type="hidden" id="modal-user-id-original"> <div class="modal-header">
            <div class="modal-avatar" id="modal-avatar">U</div>
            <div class="modal-title">
                <h3 id="modal-name">Nome do Usuário</h3>
                <p id="modal-role">Cargo</p>
            </div>
        </div>

        <div class="credentials-box">
            <div class="cred-row">
                <span class="cred-label">Usuário (Login):</span>
                <div class="cred-value-group">
                    <input type="text" id="display-login" class="cred-value">
                </div>
            </div>
            <div class="cred-row">
                <span class="cred-label">Senha:</span>
                <div class="cred-value-group">
                    <input type="password" id="display-password" class="cred-value">
                    <button class="btn-toggle-pass" onclick="togglePassword('display-password')" title="Visualizar">
                        <svg style="width:20px;height:20px;fill:currentColor;" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <h4 style="margin-bottom: 1rem; color: var(--color-black-rich);">Módulos Permitidos</h4>
        <div class="permissions-grid" id="permissions-container">
            </div>

        <div class="modal-footer">
            <button class="btn-delete-user" onclick="deleteUser()">Excluir</button>
            <div class="footer-actions">
                <button class="btn-cancel" onclick="closeModal('user-modal')">Cancelar</button>
                <button class="btn-save" onclick="saveUser()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="create-modal" class="modal-container">
        <div class="modal-header" style="border-bottom:none; margin-bottom:1rem;">
            <div class="modal-title">
                <h3>Novo Usuário</h3>
                <p>Preencha os dados para criar um acesso.</p>
            </div>
        </div>
        
        <form id="form-create" onsubmit="event.preventDefault(); createUser();">
            <div class="form-group">
                <label class="form-label">Nome Completo</label>
                <input type="text" id="new-name" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Cargo / Perfil</label>
                <select id="new-role" class="form-control" required>
                    <option value="Atendente">Atendente (Recepção)</option>
                    <option value="Dentista">Dentista</option>
                    <option value="Gerente">Gerente (Admin)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Usuário (Login)</label>
                <input type="text" id="new-login" class="form-control" required placeholder="Sem espaços">
            </div>
            <div class="form-group">
                <label class="form-label">Senha</label>
                <div style="position:relative;">
                    <input type="password" id="new-password" class="form-control" required>
                    <button type="button" class="btn-toggle-pass" onclick="togglePassword('new-password')" style="position:absolute; right:10px; top:35px;">
                        <svg style="width:18px;height:18px;fill:currentColor;" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                    </button>
                </div>
            </div>

            <div class="modal-footer" style="justify-content: flex-end; margin-top: 1.5rem;">
                <div class="footer-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('create-modal')">Cancelar</button>
                    <button type="submit" class="btn-save">Criar Usuário</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        const MODULES = [
            { id: 'dashboard', name: 'Visão Geral' },
            { id: 'agenda', name: 'Agenda' },
            { id: 'pacientes', name: 'Pacientes' },
            { id: 'prontuario', name: 'Prontuário' },
            { id: 'orcamento', name: 'Orçamentos' },
            { id: 'procedimentos', name: 'Procedimentos' },
            { id: 'financeiro', name: 'Financeiro' },
            { id: 'permissoes', name: 'Admin System' }
        ];

        const ROLE_DEFAULTS = {
            'Atendente': { redirect: 'perfil_atendente.html', access: ['agenda', 'pacientes', 'orcamento'] },
            'Dentista': { redirect: 'perfil_dentista.html', access: ['dashboard', 'agenda', 'pacientes', 'prontuario', 'financeiro'] },
            'Gerente': { redirect: 'perfil_gerente.html', access: ['dashboard', 'agenda', 'pacientes', 'prontuario', 'orcamento', 'procedimentos', 'financeiro'] }
        };

        // Fallback inicial (caso localStorage esteja vazio)
        const DEFAULT_USERS = [
            { id: 'hilda', name: 'Hilda Scarparo', role: 'Gerente', pass: 'adminhilda', redirect: 'perfil_gerente.html', access: ['dashboard', 'agenda', 'pacientes', 'prontuario', 'orcamento', 'procedimentos', 'financeiro'] },
            { id: 'henrique', name: 'Dr. Henrique', role: 'Dentista', pass: 'adminhenrique', redirect: 'perfil_dentista.html', access: ['dashboard', 'agenda', 'pacientes', 'prontuario', 'financeiro'] },
            { id: 'jessica', name: 'Jéssica', role: 'Atendente', pass: 'atendente', redirect: 'perfil_atendente.html', access: ['agenda', 'pacientes', 'orcamento'] },
            { id: 'admin', name: 'Super Admin', role: 'Sistema', pass: 'admin', redirect: 'permissoes_sistema.html', access: ['permissoes'] }
        ];

        let usersDB = [];
        let editingUserIndex = null;

        window.onload = function() {
            const stored = localStorage.getItem('scarparo_users');
            if (stored) {
                usersDB = JSON.parse(stored);
            } else {
                usersDB = DEFAULT_USERS;
                localStorage.setItem('scarparo_users', JSON.stringify(usersDB));
            }
            renderList();
        };

        function renderList() {
            const container = document.getElementById('user-list');
            const term = document.getElementById('search-input').value.toLowerCase();
            container.innerHTML = '';

            usersDB.forEach((user, index) => {
                if (!user.name.toLowerCase().includes(term) && !user.id.includes(term)) return;
                if (user.id === 'admin') return; // Protege Super Admin

                const html = `
                <li class="user-item" onclick="openUserModal(${index})">
                    <div class="avatar">${user.name.charAt(0)}</div>
                    <div class="info">
                        <h3>${user.name}</h3>
                        <span>${user.role} • ${user.id}</span>
                    </div>
                    <span class="role-badge">Editar</span>
                    <span class="arrow-icon">➜</span>
                </li>`;
                container.innerHTML += html;
            });
        }

        // --- MODAL EDITAR ---
        function openUserModal(index) {
            editingUserIndex = index;
            const user = usersDB[index];

            document.getElementById('modal-user-id-original').value = user.id; // Guarda ID original
            document.getElementById('modal-avatar').innerText = user.name.charAt(0);
            document.getElementById('modal-name').innerText = user.name;
            document.getElementById('modal-role').innerText = user.role;
            
            // Preenche campos editáveis
            document.getElementById('display-login').value = user.id;
            document.getElementById('display-password').value = user.pass;
            document.getElementById('display-password').type = "password";

            const permContainer = document.getElementById('permissions-container');
            permContainer.innerHTML = '';

            MODULES.forEach(mod => {
                if (mod.id === 'permissoes') return; // Esconde módulo de admin
                const isChecked = user.access.includes(mod.id) ? 'checked' : '';
                permContainer.innerHTML += `
                    <label class="perm-item">
                        <input type="checkbox" class="perm-check" value="${mod.id}" ${isChecked}>
                        <span class="perm-label">${mod.name}</span>
                    </label>
                `;
            });

            openModal('user-modal');
        }

        function saveUser() {
            if (editingUserIndex === null) return;

            const newLogin = document.getElementById('display-login').value.trim().toLowerCase();
            const newPass = document.getElementById('display-password').value.trim();
            const originalId = document.getElementById('modal-user-id-original').value;

            if (!newLogin || !newPass) { showToast("Preencha login e senha!", "error"); return; }

            // Verifica se login mudou e se já existe
            if (newLogin !== originalId) {
                const exists = usersDB.some(u => u.id === newLogin);
                if (exists) { showToast("Este usuário já existe!", "error"); return; }
            }

            // Coleta Permissões
            const checkboxes = document.querySelectorAll('.perm-check:checked');
            const newAccess = Array.from(checkboxes).map(cb => cb.value);

            // Atualiza
            usersDB[editingUserIndex].id = newLogin;
            usersDB[editingUserIndex].pass = newPass;
            usersDB[editingUserIndex].access = newAccess;

            localStorage.setItem('scarparo_users', JSON.stringify(usersDB));
            renderList();
            closeModal('user-modal');
            showToast("Usuário atualizado com sucesso!");
        }

        function deleteUser() {
            if(confirm('Tem certeza que deseja excluir este usuário?')) {
                usersDB.splice(editingUserIndex, 1);
                localStorage.setItem('scarparo_users', JSON.stringify(usersDB));
                renderList();
                closeModal('user-modal');
                showToast("Usuário excluído.");
            }
        }

        // --- MODAL CRIAR ---
        function openCreateModal() {
            document.getElementById('form-create').reset();
            openModal('create-modal');
        }

        function createUser() {
            const name = document.getElementById('new-name').value;
            const role = document.getElementById('new-role').value;
            const login = document.getElementById('new-login').value.toLowerCase().trim();
            const pass = document.getElementById('new-password').value;

            if(usersDB.find(u => u.id === login)) {
                showToast("Este usuário já existe!", "error");
                return;
            }

            const config = ROLE_DEFAULTS[role];
            const newUser = {
                id: login, name: name, role: role, pass: pass,
                redirect: config.redirect, access: config.access
            };

            usersDB.push(newUser);
            localStorage.setItem('scarparo_users', JSON.stringify(usersDB));
            renderList();
            closeModal('create-modal');
            showToast("Usuário criado com sucesso!");
        }

        // --- UTILITÁRIOS ---
        function openModal(id) { document.getElementById(id).style.display='block'; document.getElementById('modal-overlay').style.display='block'; }
        function closeModal(id) { document.getElementById(id || 'user-modal').style.display='none'; document.getElementById('create-modal').style.display='none'; document.getElementById('modal-overlay').style.display='none'; editingUserIndex = null; }
        
        function togglePassword(fieldId) {
            const input = document.getElementById(fieldId);
            input.type = input.type === "password" ? "text" : "password";
        }

        function showToast(msg, type='success') {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerText = msg;
            c.appendChild(t);
            setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(), 300); }, 3000);
        }
    </script>
</body>
</html>