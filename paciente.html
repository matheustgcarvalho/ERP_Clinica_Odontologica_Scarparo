<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Pacientes</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Identidade Visual Scarparo --- */
        :root {
            --color-black-rich: #121212;
            --color-white-bg: #F4F6F9;
            --color-white-pure: #FFFFFF;
            --color-gold-matte: #B9965B;
            --color-gold-light: #F5EFE6;
            --color-text-dark: #333333;
            --color-text-gray: #757575;
            --color-gray-border: #E0E0E0;
            --color-success: #27AE60; 
            --color-danger: #E74C3C;
            --color-info-bg: #e0f2fe; 
            --color-info-text: #0284c7; 
            --color-info-border: #bae6fd;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body { 
            background-color: var(--color-white-bg); 
            padding: 1.5rem; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* --- HEADER --- */
        .page-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1.5rem; 
            flex-shrink: 0; 
        }
        .page-title h2 { font-size: 1.5rem; font-weight: 600; color: var(--color-black-rich); margin: 0; }
        .page-title p { color: var(--color-text-gray); font-size: 0.9rem; margin: 0; }

        .btn-gold { 
            background-color: var(--color-gold-matte); 
            color: var(--color-black-rich); 
            border: none; 
            padding: 0.6rem 1.2rem; 
            border-radius: 6px; 
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: 0.2s; 
        }
        .btn-gold:hover { background-color: #a3844a; transform: translateY(-2px); }

        /* --- BARRA DE PESQUISA --- */
        .search-bar-container { 
            background: var(--color-white-pure); 
            padding: 1rem; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
            margin-bottom: 1rem; 
            display: flex; 
            gap: 1rem; 
            flex-shrink: 0; 
        }
        .search-input { 
            flex: 1; 
            padding: 0.8rem; 
            border: 1px solid var(--color-gray-border); 
            border-radius: 6px; 
            outline: none; 
        }
        .search-input:focus { border-color: var(--color-gold-matte); }

        /* --- TABELA --- */
        .patients-table-wrapper { 
            overflow-y: auto; 
            flex: 1; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
            background: var(--color-white-pure);
        }
        .patients-table { width: 100%; border-collapse: collapse; }
        .patients-table th, .patients-table td { padding: 1rem; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .patients-table th { 
            background-color: #fafafa; 
            color: var(--color-text-gray); 
            font-weight: 500; 
            font-size: 0.9rem; 
            position: sticky; 
            top: 0; 
        }
        .no-results { text-align: center; padding: 2rem; color: #888; display: none; }

        /* --- BOT√ïES DE A√á√ÉO --- */
        .btn-action { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: 0.2s; }
        
        /* Visualizar (Azul) */
        .btn-view-action { 
            background-color: var(--color-info-bg); 
            color: var(--color-info-text); 
            border: 1px solid var(--color-info-border); 
        }
        .btn-view-action:hover { background-color: var(--color-info-border); color: #000; }

        /* Excluir (Vermelho) */
        .btn-delete { 
            background-color: #FDEDEC; 
            color: var(--color-danger); 
            border: 1px solid #f5c6cb; 
            margin-left: 5px; 
        }
        .btn-delete:hover { background-color: var(--color-danger); color: white; }
        
        /* Bot√µes Gerais do Modal */
        .btn-cancel { background: #eee; color: #333; }
        .btn-edit-mode { background: #fff; border: 1px solid #ccc; color: #333; }

        /* --- MODAIS & OVERLAY --- */
        .overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px); 
        }
        
        /* Form Modal */
        .form-container { 
            background: var(--color-white-pure); 
            padding: 2rem; 
            border-radius: 12px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
            display: none; 
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            width: 90%; max-width: 700px; 
            z-index: 1000; 
            border: 1px solid var(--color-gray-border); 
            max-height: 90vh; 
            overflow-y: auto; 
        }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-label { font-size: 0.9rem; font-weight: 500; color: var(--color-text-dark); }
        .form-control { padding: 0.8rem; border: 1px solid var(--color-gray-border); border-radius: 6px; outline: none; background-color: #FAFAFA; }
        .form-control:focus { border-color: var(--color-gold-matte); background: #fff; }
        .form-control:disabled { background-color: #f3f3f3; color: #777; cursor: not-allowed; border-color: #eee; }
        .full-width { grid-column: 1 / -1; }

        /* Confirm Modal */
        .confirm-modal-box { 
            background: white; padding: 2rem; border-radius: 12px; width: 100%; max-width: 400px; 
            text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            z-index: 1001; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
        }
        .confirm-title { font-size: 1.2rem; font-weight: 600; color: var(--color-black-rich); margin-bottom: 1rem; }
        .confirm-text { color: var(--color-text-gray); margin-bottom: 2rem; font-size: 0.95rem; }
        .confirm-actions { display: flex; justify-content: center; gap: 1rem; }

        /* --- TOAST NOTIFICATION --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 250px; padding: 15px 20px; border-radius: 8px; color: white; font-size: 0.9rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease; display: flex; align-items: center; justify-content: space-between; }
        .toast-success { background-color: var(--color-success); }
        .toast-error { background-color: var(--color-danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    </style>
</head>
<body>

    <div id="toast-container"></div>
    <div id="modal-overlay" class="overlay"></div>

    <div id="delete-patient-modal" class="confirm-modal-box">
        <h3 class="confirm-title" style="color: var(--color-danger);">Excluir Paciente?</h3>
        <p class="confirm-text">Tem certeza que deseja remover este paciente? Seus agendamentos <b>n√£o</b> ser√£o apagados da agenda.</p>
        <div class="confirm-actions">
            <button class="btn-action btn-cancel" onclick="closeDeletePatientModal()">Cancelar</button>
            <button class="btn-action btn-delete" onclick="executeDeletePatient()">Excluir Paciente</button>
        </div>
    </div>

    <div class="page-header">
        <div class="page-title">
            <h2>Gest√£o de Pacientes</h2>
            <p>Base de dados completa.</p>
        </div>
        <button class="btn-gold" onclick="openNewPatientForm()">Novo Paciente</button>
    </div>

    <div class="search-bar-container">
        <input type="text" id="search-input" class="search-input" placeholder="Pesquise por nome ou CPF..." onkeyup="searchPatients()">
        <button class="btn-gold" onclick="searchPatients()">Buscar</button>
    </div>

    <div class="patients-table-wrapper">
        <table class="patients-table">
            <thead>
                <tr>
                    <th>Nome Completo</th>
                    <th>CPF</th>
                    <th>Celular</th>
                    <th>Endere√ßo Completo</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="patients-table-body">
                </tbody>
        </table>
        <div id="no-results" class="no-results">Nenhum paciente encontrado.</div>
    </div>

    <div id="new-patient-form" class="form-container">
        <h3 id="form-title" style="margin-bottom: 1.5rem; color: var(--color-black-rich);">Ficha de Cadastro</h3>
        <form id="form-patient">
            <input type="hidden" id="p-id">
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Nome Completo</label>
                    <input type="text" id="p-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">CPF</label>
                    <input type="text" id="p-cpf" class="form-control" maxlength="14" oninput="maskCPF(this)" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Data de Nascimento</label>
                    <input type="date" id="p-birth" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Celular</label>
                    <input type="text" id="p-phone" class="form-control" maxlength="15" oninput="maskPhone(this)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">CEP (Busca Auto)</label>
                    <input type="text" id="p-cep" class="form-control" maxlength="9" oninput="maskCEP(this)" onblur="buscaCEP(this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label">Cidade</label>
                    <input type="text" id="p-city" class="form-control">
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Rua</label>
                    <input type="text" id="p-street" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">N√∫mero</label>
                    <input type="text" id="p-number" class="form-control">
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Observa√ß√µes M√©dicas</label>
                    <textarea id="p-notes" class="form-control" rows="3"></textarea>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn-action btn-cancel" onclick="closeForm()">Cancelar</button>
                
                <button type="button" id="btn-edit-patient" class="btn-action btn-edit-mode" style="display:none;" onclick="enableEditMode()">Editar</button>
                
                <button type="button" id="btn-save-patient" class="btn-gold" onclick="savePatient()">Salvar</button>
            </div>
        </form>
    </div>

    <script>
        // --- DADOS (Mesmo Storage da Agenda) ---
        let patientsData = [];
        let pendingDeletePatientId = null;

        // --- L√ìGICA DE PERMISS√ÉO ---
        function checkPermissions() {
            const urlParams = new URLSearchParams(window.location.search);
            const role = urlParams.get('role');

            // Se n√£o for admin, remove visualmente os bot√µes de excluir
            if (role !== 'admin') {
                const style = document.createElement('style');
                style.innerHTML = `.btn-delete { display: none !important; }`;
                document.head.appendChild(style);
            }
        }

        window.onload = function() {
            checkPermissions(); 
            patientsData = JSON.parse(localStorage.getItem('scarparo_patients')) || [];
            renderPatientsTable();
        };

        // --- RENDERIZAR TABELA ---
        function renderPatientsTable() {
            const tbody = document.getElementById('patients-table-body');
            tbody.innerHTML = '';
            
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = patientsData.filter(p => p.name.toLowerCase().includes(term) || p.cpf.includes(term));

            if(filtered.length === 0) { 
                document.getElementById('no-results').style.display='block'; 
                return; 
            }
            document.getElementById('no-results').style.display='none';
            
            filtered.forEach(p => {
                const address = p.street ? `${p.street}, ${p.number} - ${p.city}` : '-';
                const row = `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.cpf}</td>
                    <td>${p.phone}</td>
                    <td>${address}</td>
                    <td>
                        <button class="btn-action btn-view-action" onclick="viewPatient('${p.id}')">Visualizar</button>
                        <button class="btn-action btn-delete" onclick="openDeletePatientModal('${p.id}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function searchPatients() {
            renderPatientsTable();
        }

        // --- ABRIR MODAL (NOVO / VISUALIZAR / EDITAR) ---
        function togglePatientFormState(mode) {
            const inputs = document.querySelectorAll('#form-patient input, #form-patient textarea');
            const btnSave = document.getElementById('btn-save-patient');
            const btnEdit = document.getElementById('btn-edit-patient');
            const title = document.getElementById('form-title');

            if (mode === 'view') {
                inputs.forEach(el => el.disabled = true);
                btnSave.style.display = 'none';
                btnEdit.style.display = 'block';
                title.innerText = "Visualizar Paciente";
            } else if (mode === 'edit') {
                inputs.forEach(el => el.disabled = false);
                btnSave.style.display = 'block';
                btnEdit.style.display = 'none';
                title.innerText = "Editar Paciente";
            } else if (mode === 'new') {
                inputs.forEach(el => el.disabled = false);
                btnSave.style.display = 'block';
                btnEdit.style.display = 'none';
                title.innerText = "Novo Paciente";
            }
        }

        function openNewPatientForm() {
            document.getElementById('form-patient').reset();
            document.getElementById('p-id').value = ""; 
            togglePatientFormState('new');
            document.getElementById('new-patient-form').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
        }

        function viewPatient(id) {
            const p = patientsData.find(x => String(x.id) === String(id));
            if(p) {
                fillPatientForm(p);
                togglePatientFormState('view');
                document.getElementById('new-patient-form').style.display = 'block';
                document.getElementById('modal-overlay').style.display = 'block';
            }
        }

        function enableEditMode() {
            togglePatientFormState('edit');
        }

        function fillPatientForm(p) {
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-cpf').value = p.cpf;
            document.getElementById('p-birth').value = p.birth || '';
            document.getElementById('p-phone').value = p.phone;
            document.getElementById('p-cep').value = p.cep || '';
            document.getElementById('p-city').value = p.city || '';
            document.getElementById('p-street').value = p.street || '';
            document.getElementById('p-number').value = p.number || '';
            document.getElementById('p-notes').value = p.notes || '';
        }

        function closeForm() {
            document.getElementById('new-patient-form').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none';
        }

        // --- SALVAR PACIENTE ---
        function savePatient() {
             const id = document.getElementById('p-id').value;
             const name = document.getElementById('p-name').value;
             
             if(!name) { 
                 showToast("Nome √© obrigat√≥rio!", "error");
                 return; 
             }

             const formData = { 
                 id: (id && id !== "") ? id : String(Date.now()), 
                 name: name, 
                 cpf: document.getElementById('p-cpf').value, 
                 birth: document.getElementById('p-birth').value,
                 phone: document.getElementById('p-phone').value, 
                 cep: document.getElementById('p-cep').value,
                 city: document.getElementById('p-city').value,
                 street: document.getElementById('p-street').value,
                 number: document.getElementById('p-number').value,
                 notes: document.getElementById('p-notes').value
             }; 
             
             if(id && id !== "") { 
                 const idx = patientsData.findIndex(p => String(p.id) === String(id)); 
                 patientsData[idx] = formData; 
                 showToast("Paciente atualizado com sucesso!", "success");
             } else { 
                 patientsData.push(formData); 
                 showToast("Paciente cadastrado com sucesso!", "success");
             }
             
             localStorage.setItem('scarparo_patients', JSON.stringify(patientsData)); 
             
             renderPatientsTable();
             closeForm();
        }

        // --- EXCLUS√ÉO ---
        function openDeletePatientModal(id) {
            pendingDeletePatientId = id;
            document.getElementById('delete-patient-modal').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('delete-patient-modal').style.zIndex = '1002';
        }

        function closeDeletePatientModal() {
            pendingDeletePatientId = null;
            document.getElementById('delete-patient-modal').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function executeDeletePatient() {
            if(pendingDeletePatientId) {
                patientsData = patientsData.filter(p => String(p.id) !== String(pendingDeletePatientId));
                localStorage.setItem('scarparo_patients', JSON.stringify(patientsData));
                renderPatientsTable();
                showToast("Paciente exclu√≠do.", "success");
                closeDeletePatientModal();
            }
        }

        // --- TOAST SYSTEM ---
        function showToast(message, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerText = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- UTILIT√ÅRIOS ---
        function buscaCEP(cep) {
            cep = cep.replace(/\D/g, '');
            if(cep.length === 8) {
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(res => res.json())
                .then(data => {
                    if(!data.erro) {
                        document.getElementById('p-street').value = data.logradouro;
                        document.getElementById('p-city').value = data.localidade;
                        document.getElementById('p-number').focus();
                    }
                });
            }
        }

        function maskCEP(i){ i.value = i.value.replace(/\D/g,"").replace(/^(\d{5})(\d)/,"$1-$2"); }
        function maskCPF(i){ i.value = i.value.replace(/\D/g,"").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2"); }
        function maskPhone(i){ i.value = i.value.replace(/\D/g,"").replace(/^(\d{2})(\d)/g,"($1) $2").replace(/(\d)(\d{4})$/,"$1-$2"); }
    </script>
</body>
</html>