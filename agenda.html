<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Componente Agenda</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-black-rich: #121212; --color-white-bg: #F4F6F9; --color-white-pure: #FFFFFF;
            --color-gold-matte: #B9965B; --color-gold-light: #F5EFE6;
            --color-text-dark: #333333; --color-text-gray: #757575;
            --color-gray-border: #E0E0E0; --color-success: #27AE60; --color-success-bg: #E8F8F5;
            --color-pending: #F1C40F; --color-pending-bg: #FEF9E7; --color-danger: #E74C3C;
            --color-info-bg: #e0f2fe; --color-info-text: #0284c7; --color-info-border: #bae6fd;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--color-white-bg); padding: 1.5rem; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* SEÇÕES */
        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        /* HEADER */
        .agenda-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-shrink: 0; }
        .page-title h2 { font-size: 1.5rem; font-weight: 600; color: var(--color-black-rich); margin: 0; }
        .page-title p { color: var(--color-text-gray); font-size: 0.9rem; margin: 0; }

        /* BOTÕES */
        .btn-gold { background-color: var(--color-gold-matte); color: var(--color-black-rich); border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-gold:hover { background-color: #a3844a; transform: translateY(-2px); }
        
        .view-controls { display: flex; gap: 10px; background: #fff; padding: 5px; border-radius: 8px; border: 1px solid var(--color-gray-border); }
        .view-btn { background: none; border: none; padding: 8px; cursor: pointer; border-radius: 6px; color: var(--color-text-gray); transition: 0.2s; }
        .view-btn:hover { background: #f0f0f0; }
        .view-btn.active { background: var(--color-gold-matte); color: var(--color-black-rich); }
        .view-btn svg { width: 20px; height: 20px; fill: currentColor; }

        /* VISÃO LISTA */
        .list-filter-row { display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; background: #fff; padding: 10px 15px; border-radius: 8px; border: 1px solid var(--color-gray-border); width: fit-content; flex-shrink: 0; }
        .agenda-grid-list { display: flex; flex-direction: column; gap: 1rem; overflow-y: auto; padding-bottom: 2rem; }
        
        .appointment-card-modern { background: var(--color-white-pure); border-radius: 12px; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid transparent; transition: all 0.2s; cursor: pointer; flex-shrink: 0; }
        .appointment-card-modern:hover { border-color: var(--color-gold-matte); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card-time-box { background-color: var(--color-gold-light); color: #8A6D3B; font-weight: 700; font-size: 0.95rem; padding: 8px 12px; border-radius: 8px; margin-right: 20px; min-width: 120px; text-align: center; }
        .card-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .card-info h4 { margin: 0; color: var(--color-black-rich); font-size: 1rem; font-weight: 600; }
        .card-info p { margin: 2px 0 0 0; color: var(--color-text-gray); font-size: 0.85rem; }
        .card-actions { display: flex; align-items: center; gap: 15px; }
        .status-badge { font-size: 0.8rem; padding: 6px 12px; border-radius: 20px; font-weight: 600; cursor: pointer; border: 1px solid transparent; user-select: none; transition: 0.2s; }
        .status-pending { background-color: var(--color-pending-bg); color: var(--color-pending); }
        .status-confirmed { background-color: var(--color-success-bg); color: var(--color-success); }
        .btn-whatsapp-icon { background-color: #25D366; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(37, 211, 102, 0.3); text-decoration: none; }
        .btn-whatsapp-icon svg { width: 20px; height: 20px; fill: white; }
        .no-results { text-align: center; padding: 2rem; color: #888; display: none; }

        /* VISÃO TEAMS */
        .week-calendar-container { background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); overflow: hidden; display: none; flex-direction: column; flex: 1; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1.5rem; border-bottom: 1px solid var(--color-gray-border); background-color: #fff; flex-shrink: 0; }
        .cal-nav-btn { background: none; border: 1px solid var(--color-gray-border); padding: 5px 12px; border-radius: 6px; cursor: pointer; }
        .week-picker-input { border: 1px solid var(--color-gray-border); padding: 5px; border-radius: 6px; font-family: 'Poppins', sans-serif; cursor: pointer; }
        .calendar-grid { display: grid; grid-template-columns: 60px repeat(6, 1fr); overflow-y: auto; flex: 1; }
        .cal-head-cell { padding: 10px; text-align: center; font-weight: 600; color: var(--color-text-gray); border-bottom: 1px solid var(--color-gray-border); border-right: 1px solid #f0f0f0; background: #fafafa; position: sticky; top: 0; z-index: 10; font-size: 0.85rem; }
        .cal-time-cell { height: 60px; padding-top: 5px; font-size: 0.8rem; color: var(--color-text-gray); text-align: center; font-weight: 500; border-right: 1px solid var(--color-gray-border); border-bottom: 1px solid #f0f0f0; background: #fff; display: flex; justify-content: center; align-items: flex-start; }
        .cal-slot { border-right: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; position: relative; height: 60px; }
        .cal-slot:hover { background: #fafafa; }
        .cal-event { position: absolute; left: 4px; right: 4px; background-color: var(--color-gold-light); border-left: 4px solid var(--color-gold-matte); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; overflow: visible; z-index: 50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .cal-event.confirmed-event { background-color: #dcfce7; border-left-color: #22c55e; }
        .cal-event-title { font-weight: 700; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cal-event-time { color: var(--color-text-gray); font-size: 0.7rem; display: block; margin-top: 2px; }
        .event-tooltip { display: none; position: absolute; left: 102%; top: 0; width: 200px; background: var(--color-white-pure); border: 1px solid var(--color-gold-matte); box-shadow: 0 4px 20px rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; z-index: 200; pointer-events: none; text-align: left; }
        .cal-event:hover .event-tooltip { display: block; }
        .tooltip-name { display: block; font-size: 0.9rem; font-weight: 700; color: var(--color-black-rich); margin-bottom: 4px; }
        .tooltip-proc { display: block; font-size: 0.8rem; color: var(--color-text-gray); margin-bottom: 8px; }

        /* MODAIS & FORMS */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px); }
        
        .form-container { background: var(--color-white-pure); padding: 2rem; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px; z-index: 1000; border: 1px solid var(--color-gray-border); max-height: 90vh; overflow-y: auto; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; position: relative; }
        .form-label { font-size: 0.9rem; font-weight: 500; color: var(--color-text-dark); }
        .form-control { padding: 0.8rem; border: 1px solid var(--color-gray-border); border-radius: 6px; outline: none; background-color: #FAFAFA; }
        .form-control:focus { border-color: var(--color-gold-matte); background: #fff; }
        .form-control:disabled { background-color: #f3f3f3; color: #777; cursor: not-allowed; }
        .full-width { grid-column: 1 / -1; }
        .patient-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid var(--color-gray-border); z-index: 1010; display: none; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .suggestion-item:hover { background: var(--color-gold-light); }
        
        .confirm-modal-box { background: white; padding: 2rem; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .confirm-title { font-size: 1.2rem; font-weight: 600; color: var(--color-black-rich); margin-bottom: 1rem; }
        .confirm-text { color: var(--color-text-gray); margin-bottom: 2rem; font-size: 0.95rem; }
        .confirm-actions { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
        .btn-action { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; font-size: 0.85rem; }
        .btn-delete { background-color: #FDEDEC; color: var(--color-danger); }

        /* --- TOAST NOTIFICATION --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 250px; padding: 15px 20px; border-radius: 8px; color: white; font-size: 0.9rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease; display: flex; align-items: center; justify-content: space-between; }
        .toast-success { background-color: var(--color-success); }
        .toast-error { background-color: var(--color-danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    </style>
</head>
<body>

    <div id="toast-container"></div>
    <div id="modal-overlay" class="overlay"></div>

    <div id="delete-confirmation-modal" class="confirm-modal-box">
        <h3 class="confirm-title">Tem certeza?</h3><p class="confirm-text">Deseja excluir este agendamento?</p>
        <div class="confirm-actions"><button class="btn-action" style="background: #eee; color: #333;" onclick="closeModal('delete-confirmation-modal')">Cancelar</button><button class="btn-action btn-delete" onclick="executeDelete()">Sim, Excluir</button></div>
    </div>
    <div id="conflict-modal" class="confirm-modal-box">
        <h3 class="confirm-title" style="color: var(--color-danger);">Horário Indisponível!</h3><p class="confirm-text">Já existe um paciente agendado nesta data e horário.</p>
        <div class="confirm-actions"><button class="btn-gold" onclick="closeModal('conflict-modal')">Entendido</button></div>
    </div>

    <div class="agenda-header">
        <div class="page-title"><h2>Agenda</h2><p>Gerenciamento de horários</p></div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="view-controls">
                <button class="view-btn" id="btn-list" onclick="toggleView('list')" title="Lista"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></button>
                <button class="view-btn active" id="btn-week" onclick="toggleView('week')" title="Semana"><svg viewBox="0 0 24 24"><path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z"/></svg></button>
            </div>
            <button class="btn-gold" onclick="openApptForm()">Marcar Paciente</button>
        </div>
    </div>

    <div id="list-view-wrapper" style="display:none;">
        <div class="list-filter-row"><span class="list-filter-label">Visualizando dia:</span><input type="date" id="filter-date" class="form-control" style="width:auto; padding:5px;" onchange="renderAgenda()"></div>
        <div id="agenda-list" class="agenda-grid-list"></div>
        <div id="no-appts" class="no-results" style="display:block;">Nenhum agendamento encontrado para este dia.</div>
    </div>

    <div id="week-view-wrapper" class="week-calendar-container" style="display:flex;">
        <div class="calendar-header">
            <button class="cal-nav-btn" onclick="changeWeek(-1)">&lt;</button>
            <input type="week" id="week-picker" class="week-picker-input" style="border:none;" onchange="changeWeekFromInput()">
            <button class="cal-nav-btn" onclick="changeWeek(1)">&gt;</button>
        </div>
        <div class="calendar-grid" id="teams-grid"></div>
    </div>

    <div id="appt-form" class="form-container">
        <h3 id="appt-title" style="margin-bottom: 1.5rem; color: var(--color-black-rich);">Novo Agendamento</h3>
        <form id="form-appt">
            <input type="hidden" id="appt-id"><input type="hidden" id="appt-pid">
            <div class="form-grid">
                <div class="form-group full-width" style="position:relative;">
                    <label class="form-label">Pesquisar Paciente</label>
                    <input type="text" id="appt-patient-search" class="form-control" placeholder="Digite o nome..." autocomplete="off">
                    <div id="appt-suggestions" class="patient-suggestions"></div>
                </div>
                <div class="form-group"><label class="form-label">Data da Consulta</label><input type="date" id="appt-date" class="form-control"></div>
                <div class="form-group"><label class="form-label">Procedimento</label><input type="text" id="appt-proc" class="form-control" placeholder="Ex: Limpeza"></div>
                <div class="form-group"><label class="form-label">Início</label><input type="time" id="appt-start" class="form-control"></div>
                <div class="form-group"><label class="form-label">Fim</label><input type="time" id="appt-end" class="form-control"></div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:1rem;">
                <button type="button" class="btn-action btn-delete" id="btn-del-appt" style="display:none;" onclick="openModal('delete-confirmation-modal')">Excluir</button>
                <button type="button" class="btn-action" style="background:#eee; color:#333;" onclick="closeModal('appt-form')">Cancelar</button>
                <button type="button" class="btn-gold" onclick="saveAppt()">Salvar</button>
            </div>
        </form>
    </div>

    <script>
        let patients = [], appts = [], weekStart = new Date(), delApptId = null;
        function getMonday(d){ d=new Date(d); var day=d.getDay(), diff=d.getDate()-day+(day==0?-6:1); return new Date(d.setDate(diff)); }

        window.onload = function() {
            loadData();
            const today = new Date();
            document.getElementById('filter-date').value = today.toISOString().split('T')[0];
            weekStart = getMonday(today);
            initTeamsGrid();
            toggleView('week'); // Padrão Teams
            updateWeekPicker();
        };

        function loadData() {
            patients = JSON.parse(localStorage.getItem('scarparo_patients')) || [];
            appts = JSON.parse(localStorage.getItem('scarparo_appointments')) || [];
        }

        function toggleView(type) {
            const list = document.getElementById('list-view-wrapper');
            const week = document.getElementById('week-view-wrapper');
            if(type==='list') { list.style.display='block'; week.style.display='none'; document.getElementById('btn-list').classList.add('active'); document.getElementById('btn-week').classList.remove('active'); }
            else { list.style.display='none'; week.style.display='flex'; document.getElementById('btn-list').classList.remove('active'); document.getElementById('btn-week').classList.add('active'); }
            renderAgenda();
        }

        function renderAgenda() {
            loadData();
            // LISTA
            const container = document.getElementById('agenda-list');
            const dateFilter = document.getElementById('filter-date').value;
            container.innerHTML = '';
            const daily = appts.filter(a => a.date === dateFilter);
            if(daily.length===0) document.getElementById('no-appts').style.display='block';
            else {
                document.getElementById('no-appts').style.display='none';
                daily.sort((a,b)=>a.start.localeCompare(b.start));
                daily.forEach(a => {
                    const p = patients.find(x=>String(x.id)===String(a.pid));
                    const name = p ? p.name : a.pname;
                    const stCls = a.status==='confirmed'?'status-confirmed':'status-pending';
                    const stTxt = a.status==='confirmed'?'Confirmado':'Pendente';
                    container.innerHTML += `
                    <div class="appointment-card-modern" onclick="openApptForm('${a.id}')">
                        <div style="display:flex;align-items:center;">
                            <div class="card-time-box">${a.start} - ${a.end}</div>
                            <div class="card-info"><h4>${name}</h4><p>${a.proc}</p></div>
                        </div>
                        <div class="card-actions"><span class="status-badge ${stCls}" onclick="event.stopPropagation();toggleStatus('${a.id}')">${stTxt}</span>
                        <a href="https://wa.me/?text=Olá ${name}" target="_blank" class="btn-whatsapp-icon"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c..."/></svg></a></div>
                    </div>`;
                });
            }
            // TEAMS
            for(let i=1; i<=6; i++) {
                let d = new Date(weekStart); d.setDate(weekStart.getDate()+(i-1));
                document.getElementById(`hd-${i}`).innerText = `${['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'][d.getDay()]} ${d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'})}`;
            }
            document.querySelectorAll('.cal-event').forEach(e => e.remove());
            const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate()+5);
            appts.forEach(a => {
                const ad = new Date(a.date.split('-'));
                if(ad >= new Date(weekStart.setHours(0,0,0,0)) && ad <= new Date(weekEnd.setHours(23,59,59,999))) {
                    const slot = document.getElementById(`slot-${ad.getDay()}-${a.start.split(':')[0]}`);
                    if(slot) {
                        const p = patients.find(x=>String(x.id)===String(a.pid));
                        const name = p ? p.name : a.pname;
                        const div = document.createElement('div');
                        div.className = `cal-event ${a.status==='confirmed'?'confirmed-event':''}`;
                        const [sh,sm]=a.start.split(':').map(Number); const [eh,em]=a.end.split(':').map(Number);
                        div.style.top = `${sm}px`; div.style.height = `${(eh*60+em)-(sh*60+sm)}px`;
                        
                        // TOOLTIP COMPLETO
                        const statusTxt = a.status === 'confirmed' ? 'Confirmado' : 'Pendente';
                        const statusCls = a.status === 'confirmed' ? 'status-confirmed' : 'status-pending';
                        
                        div.innerHTML = `
                            <span class="cal-event-title">${name}</span>
                            <span class="cal-event-time">${a.start}-${a.end}</span>
                            <div class="event-tooltip">
                                <span class="tooltip-name">${name}</span>
                                <span class="tooltip-proc">${a.proc}</span>
                                <span class="status-badge ${statusCls}" style="font-size:0.7rem; margin-top:5px; display:inline-block;">${statusTxt}</span>
                            </div>
                        `;
                        div.onclick = (e)=>{e.stopPropagation(); openApptForm(a.id);};
                        slot.appendChild(div);
                    }
                }
            });
            updateWeekPicker();
        }

        function initTeamsGrid() {
            const grid = document.getElementById('teams-grid');
            let html = '<div class="cal-head-cell"></div>';
            for(let i=1; i<=6; i++) html += `<div id="hd-${i}" class="cal-head-cell"></div>`;
            // INICIO 07:00
            for(let h=7; h<=18; h++) {
                let hh = h<10?'0'+h:h;
                html += `<div class="cal-time-cell">${hh}:00</div>`;
                for(let d=1; d<=6; d++) html += `<div id="slot-${d}-${hh}" class="cal-slot"></div>`;
            }
            grid.innerHTML = html;
        }

        function changeWeek(d) { weekStart.setDate(weekStart.getDate()+(d*7)); renderAgenda(); }
        function changeWeekFromInput() { const v=document.getElementById('week-picker').value; if(v) { const [y,w]=v.split('-W'); weekStart = getDateFromWeek(w,y); renderAgenda(); } }
        function updateWeekPicker() { const y=weekStart.getFullYear(); const d=new Date(y,0,1); const w=Math.ceil((((weekStart-d)/86400000)+d.getDay()+1)/7); document.getElementById('week-picker').value=`${y}-W${w<10?'0'+w:w}`; }
        function getDateFromWeek(w,y) { var d=new Date(y,0,1+(w-1)*7); var day=d.getDay(); var ISO=d; if(day<=4) ISO.setDate(d.getDate()-d.getDay()+1); else ISO.setDate(d.getDate()+8-d.getDay()); return ISO; }
        function toggleStatus(id) { const idx=appts.findIndex(a=>String(a.id)===String(id)); if(idx>-1){ appts[idx].status=appts[idx].status==='confirmed'?'pending':'confirmed'; localStorage.setItem('scarparo_appointments', JSON.stringify(appts)); renderAgenda(); } }
        
        function openModal(id){ document.getElementById(id).style.display='block'; document.getElementById('modal-overlay').style.display='block'; }
        function closeModal(id){ document.getElementById(id).style.display='none'; document.getElementById('modal-overlay').style.display='none'; }
        function openApptForm(id){ openModal('appt-form'); if(id){ const a=appts.find(x=>String(x.id)===String(id)); document.getElementById('appt-id').value=a.id; document.getElementById('appt-pid').value=a.pid; const p=patients.find(x=>String(x.id)===String(a.pid)); document.getElementById('appt-patient-search').value=p?p.name:a.pname; document.getElementById('appt-date').value=a.date; document.getElementById('appt-start').value=a.start; document.getElementById('appt-end').value=a.end; document.getElementById('appt-proc').value=a.proc; document.getElementById('appt-title').innerText="Editar Agendamento"; document.getElementById('btn-del-appt').style.display='block'; } else { document.getElementById('form-appt').reset(); document.getElementById('appt-id').value=''; document.getElementById('appt-title').innerText="Novo Agendamento"; document.getElementById('btn-del-appt').style.display='none'; } }
        
        function saveAppt() {
            const id = document.getElementById('appt-id').value, pid = document.getElementById('appt-pid').value, pname = document.getElementById('appt-patient-search').value;
            const date = document.getElementById('appt-date').value, start = document.getElementById('appt-start').value;
            if(!date||!start||!pname) { showToast("Preencha os dados obrigatórios.", "error"); return; }
            if(appts.find(a => a.date === date && a.start === start && String(a.id) !== String(id))) { openModal('conflict-modal'); return; }
            
            // Mantém status se for edição
            let currentStatus = 'pending';
            if (id) { const existing = appts.find(a => String(a.id) === String(id)); if (existing) currentStatus = existing.status; }

            const data = { id: id || String(Date.now()), pid, pname, date, start, end:document.getElementById('appt-end').value, proc:document.getElementById('appt-proc').value, status:currentStatus };
            if(id) { 
                const idx = appts.findIndex(a=>String(a.id)===String(id)); 
                if(idx>-1) { appts[idx]=data; } 
                showToast("Agendamento atualizado com sucesso!", "success");
            } else { 
                appts.push(data); 
                showToast("Agendamento criado com sucesso!", "success");
            }
            localStorage.setItem('scarparo_appointments', JSON.stringify(appts)); renderAgenda(); closeModal('appt-form');
        }
        
        function executeDelete() { 
            const id=document.getElementById('appt-id').value; 
            appts=appts.filter(a=>String(a.id)!==String(id)); 
            localStorage.setItem('scarparo_appointments', JSON.stringify(appts)); 
            renderAgenda(); 
            showToast("Agendamento excluído.", "success");
            closeModal('delete-confirmation-modal'); closeModal('appt-form'); 
        }
        
        // --- TOAST NOTIFICATION SYSTEM ---
        function showToast(message, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerText = message;
            
            container.appendChild(toast);

            // Remove após 3 segundos
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        document.getElementById('appt-patient-search').addEventListener('input', function(){ const t=this.value.toLowerCase(); const b=document.getElementById('appt-suggestions'); b.innerHTML=''; if(t.length>0){ const r=patients.filter(p=>p.name.toLowerCase().includes(t)); if(r.length>0){ b.style.display='block'; r.forEach(p=>{ const d=document.createElement('div'); d.className='suggestion-item'; d.innerText=p.name; d.onclick=()=>{ document.getElementById('appt-pid').value=p.id; document.getElementById('appt-patient-search').value=p.name; b.style.display='none'; }; b.appendChild(d); }); } else b.style.display='none'; } else b.style.display='none'; });
    </script>
</body>
</html>