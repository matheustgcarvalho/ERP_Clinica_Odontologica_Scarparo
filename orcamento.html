<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamentos - Scarparo</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-black-rich: #121212; --color-white-bg: #F4F6F9; --color-white-pure: #FFFFFF;
            --color-gold-matte: #B9965B; --color-gold-light: #F5EFE6;
            --color-text-dark: #333333; --color-text-gray: #757575;
            --color-gray-border: #E0E0E0; --color-success: #27AE60; --color-danger: #E74C3C;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--color-white-bg); padding: 1.5rem; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-shrink: 0; }
        .page-title h2 { font-size: 1.5rem; font-weight: 600; color: var(--color-black-rich); margin: 0; }
        .page-title p { color: var(--color-text-gray); font-size: 0.9rem; margin: 0; }

        /* Layout Principal */
        .budget-layout { display: grid; grid-template-columns: 300px 1fr; gap: 1.5rem; flex: 1; overflow: hidden; }
        
        /* Coluna Esquerda */
        .control-panel { background: var(--color-white-pure); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); display: flex; flex-direction: column; gap: 1.5rem; height: 100%; overflow-y: auto; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; position: relative; }
        .form-label { font-size: 0.85rem; font-weight: 600; color: var(--color-text-dark); }
        .form-control { padding: 0.8rem; border: 1px solid var(--color-gray-border); border-radius: 6px; outline: none; background-color: #FAFAFA; font-size: 0.9rem; }
        .form-control:focus { border-color: var(--color-gold-matte); background: #fff; }
        
        /* Coluna Direita */
        .budget-paper { 
            background: var(--color-white-pure); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
            display: flex; flex-direction: column; overflow: hidden; position: relative;
            border-top: 4px solid var(--color-gold-matte);
        }
        
        .paper-header { padding: 1.5rem; border-bottom: 1px solid #eee; background-color: #fafafa; display: flex; justify-content: space-between; align-items: center; }
        .paper-title { font-weight: 700; color: var(--color-black-rich); font-size: 1.1rem; }
        .paper-patient { color: var(--color-text-gray); font-size: 0.9rem; }
        .paper-patient strong { color: var(--color-gold-matte); }

        .items-container { flex: 1; overflow-y: auto; padding: 0; }
        .items-table { width: 100%; border-collapse: collapse; }
        .items-table th { text-align: left; padding: 1rem 1.5rem; background: #fff; color: var(--color-text-gray); font-weight: 500; font-size: 0.85rem; border-bottom: 2px solid #f0f0f0; position: sticky; top: 0; z-index: 10; }
        .items-table td { padding: 0.8rem 1.5rem; border-bottom: 1px solid #f9f9f9; color: var(--color-text-dark); font-size: 0.9rem; vertical-align: middle; }
        .items-table tr:hover { background-color: #fcfcfc; }
        
        /* Colunas da Tabela */
        .col-region { width: 150px; }
        .col-price { width: 180px; text-align: right; }
        .col-action { width: 50px; text-align: center; }

        /* --- NOVOS INPUTS DA TABELA ("Stealth Mode") --- */
        .table-input-wrapper {
            display: flex;
            align-items: center;
            /* justify-content: flex-end; REMOVIDO O Padrão */
            gap: 5px;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        /* Classes utilitárias para alinhamento */
        .wrapper-center { justify-content: center; }
        .wrapper-right { justify-content: flex-end; }

        .table-input-wrapper:hover {
            border-color: #eee;
            background-color: #fff;
        }
        .table-input-wrapper.focused {
            border-color: var(--color-gold-matte);
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(185, 150, 91, 0.1);
        }

        .table-input { 
            border: none; 
            background: transparent; 
            font-size: 0.95rem; 
            color: var(--color-black-rich); 
            width: 100%; 
            outline: none;
            font-weight: 500;
        }
        
        /* Input de Região Centralizado */
        .input-center { text-align: center; }
        /* Input de Preço Alinhado a Direita */
        .input-right { text-align: right; font-weight: 700; }

        .currency-symbol { font-size: 0.85rem; color: var(--color-text-gray); font-weight: 400; }

        .btn-remove { background: none; border: none; color: #e0e0e0; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .btn-remove:hover { color: var(--color-danger); transform: scale(1.1); }

        .paper-footer { padding: 1.5rem; background-color: #fafafa; border-top: 1px solid #eee; }
        .summary-grid { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; justify-content: end; text-align: right; }
        .summary-label { color: var(--color-text-gray); font-size: 0.9rem; }
        .summary-value { font-weight: 600; color: var(--color-black-rich); font-size: 1rem; min-width: 100px; }
        .total-value { font-size: 1.6rem; color: var(--color-gold-matte); font-weight: 700; }

        .action-bar { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end; }
        .btn-primary { background-color: var(--color-black-rich); color: var(--color-gold-matte); border: none; padding: 0.8rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; text-decoration: none; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-secondary { background-color: white; color: var(--color-text-dark); border: 1px solid var(--color-gray-border); padding: 0.8rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; text-decoration: none; display: flex; align-items: center; gap: 8px;}
        .btn-secondary:hover { background-color: #f5f5f5; }

        .input-group { display: flex; gap: 0; }
        .input-group input { border-radius: 6px 0 0 6px; flex: 1; }
        .input-group select { border-radius: 0 6px 6px 0; border: 1px solid var(--color-gray-border); border-left: none; background: #eee; outline: none; cursor: pointer; width: 60px; text-align: center; color: var(--color-text-dark); font-weight: 600; }
        
        /* Autocomplete Paciente */
        .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid var(--color-gray-border); border-radius: 0 0 8px 8px; z-index: 100; max-height: 150px; overflow-y: auto; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        .suggestion-item:hover { background: var(--color-gold-light); }

        /* BOTÃO GRANDE ADICIONAR */
        .btn-add-item { width: 100%; background-color: var(--color-gold-matte); color: #121212; padding: 1rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 1rem; display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.2s; }
        .btn-add-item:hover { background-color: #a3844a; transform: translateY(-2px); }

        /* --- MODAL DE SELEÇÃO (AUMENTADO) --- */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px); }
        
        .selection-modal { 
            background: white; 
            width: 90%; 
            max-width: 800px;
            height: 85vh;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            z-index: 1000; border-radius: 12px; display: none; flex-direction: column; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
        }
        
        .modal-header { padding: 1.5rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-title { font-size: 1.3rem; font-weight: 700; color: var(--color-black-rich); }
        
        /* CAMPO DE BUSCA DO MODAL (AUMENTADO) */
        .modal-search-box { padding: 1.5rem; border-bottom: 1px solid #f0f0f0; background: #fafafa; }
        .modal-search-input {
            width: 100%; padding: 1.2rem; font-size: 1.1rem;
            border: 2px solid var(--color-gray-border); border-radius: 8px; outline: none;
        }
        .modal-search-input:focus { border-color: var(--color-gold-matte); }

        .modal-body { flex: 1; overflow-y: auto; padding: 0; }
        
        .proc-list-item { 
            padding: 15px 2rem; border-bottom: 1px solid #f5f5f5; display: flex; align-items: center; gap: 20px; cursor: pointer; transition: 0.1s; 
        }
        .proc-list-item:hover { background-color: #f9f9f9; }
        
        .proc-check { 
            width: 24px; height: 24px; 
            cursor: pointer; accent-color: var(--color-gold-matte); 
        }
        
        .proc-name { flex: 1; font-size: 1rem; color: var(--color-text-dark); font-weight: 500; }
        .proc-price { font-weight: 700; color: var(--color-black-rich); font-size: 1.1rem; }

        .modal-footer { padding: 1.5rem; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 15px; flex-shrink: 0; background: #fff; border-radius: 0 0 12px 12px;}
    </style>
</head>
<body>

    <div id="modal-overlay" class="overlay"></div>

    <div id="selection-modal" class="selection-modal">
        <div class="modal-header">
            <span class="modal-title">Adicionar Procedimentos</span>
            <button class="btn-remove" onclick="closeSelectionModal()" style="font-size: 2rem;">&times;</button>
        </div>
        <div class="modal-search-box">
            <input type="text" id="modal-search" class="modal-search-input" placeholder="Digite para filtrar..." onkeyup="renderProcedureList()" autofocus>
        </div>
        <div class="modal-body" id="modal-list-body">
            </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeSelectionModal()">Cancelar</button>
            <button class="btn-primary" onclick="addSelectedProcedures()">Confirmar Seleção</button>
        </div>
    </div>

    <div class="page-header">
        <div class="page-title">
            <h2>Novo Orçamento</h2>
            <p>Elaboração de plano de tratamento.</p>
        </div>
    </div>

    <div class="budget-layout">
        
        <div class="control-panel">
            <div class="form-group">
                <label class="form-label">Paciente</label>
                <input type="text" id="search-patient" class="form-control" placeholder="Digite o nome..." autocomplete="off">
                <div id="patient-suggestions" class="suggestions-box"></div>
                <input type="hidden" id="selected-patient-id">
            </div>

            <hr style="border:0; border-top:1px solid #eee;">

            <div>
                <label class="form-label">Procedimentos</label>
                <button class="btn-add-item" onclick="openSelectionModal()">
                    <svg style="width:24px; height:24px; fill:currentColor;" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    Selecionar Itens
                </button>
                <p style="font-size:0.8rem; color:#777; margin-top:8px; text-align:center;">Clique para abrir a lista completa.</p>
            </div>

            <hr style="border:0; border-top:1px solid #eee; margin-top: auto;">

            <div class="form-group">
                <label class="form-label">Aplicar Desconto</label>
                <div class="input-group">
                    <input type="number" id="discount-value" class="form-control" placeholder="0" oninput="calculateTotals()">
                    <select id="discount-type" onchange="calculateTotals()">
                        <option value="money">R$</option>
                        <option value="percent">%</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="budget-paper">
            <div class="paper-header">
                <span class="paper-title">Plano de Tratamento</span>
                <span class="paper-patient" id="display-patient-name">Paciente não selecionado</span>
            </div>

            <div class="items-container">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Procedimento</th>
                            <th class="col-region" style="text-align: center;">Região/Dente</th>
                            <th class="col-price">Valor (R$)</th>
                            <th class="col-action"></th>
                        </tr>
                    </thead>
                    <tbody id="budget-items-body"></tbody>
                </table>
                <div id="empty-state" style="text-align: center; padding: 3rem; color: #ccc;">
                    Nenhum procedimento adicionado.
                </div>
            </div>

            <div class="paper-footer">
                <div class="summary-grid">
                    <span class="summary-label">Subtotal:</span>
                    <span class="summary-value" id="display-subtotal">R$ 0,00</span>
                    
                    <span class="summary-label" id="lbl-discount" style="display:none;">Desconto:</span>
                    <span class="summary-value" id="display-discount" style="color: var(--color-danger); display:none;">- R$ 0,00</span>
                    
                    <span class="summary-label" style="font-size: 1.1rem; font-weight: 700; color: var(--color-black-rich); margin-top: 10px;">Total Previsto:</span>
                    <span class="total-value" style="margin-top: 10px;" id="display-total">R$ 0,00</span>
                </div>

                <div class="action-bar">
                    <button class="btn-secondary" onclick="alert('PDF gerado! (Simulação)')">
                        <svg style="width:18px; height:18px; fill:currentColor;" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM12 7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zm-4 8h8v2H8z"/></svg>
                        Imprimir
                    </button>
                    <button class="btn-primary" onclick="sendWhatsApp()">
                        <svg style="width:18px; height:18px; fill:currentColor;" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                        Enviar WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DADOS ---
        let patients = JSON.parse(localStorage.getItem('scarparo_patients')) || [];
        let proceduresList = [];
        let budgetItems = [];
        
        window.onload = function() {
            const storedProcs = localStorage.getItem('scarparo_procedures');
            if (storedProcs) {
                proceduresList = JSON.parse(storedProcs);
            } else {
                proceduresList = [
                    {id: 1, name: "Consulta Avaliação", price: 150},
                    {id: 2, name: "Limpeza", price: 250}
                ];
            }
            proceduresList.sort((a, b) => a.name.localeCompare(b.name));
        }

        // --- BUSCA PACIENTE ---
        const searchPatient = document.getElementById('search-patient');
        const patientSuggestions = document.getElementById('patient-suggestions');
        
        searchPatient.addEventListener('input', function() {
            const term = this.value.toLowerCase();
            patientSuggestions.innerHTML = '';
            if(term.length > 0) {
                const filtered = patients.filter(p => p.name.toLowerCase().includes(term));
                if(filtered.length > 0) {
                    patientSuggestions.style.display = 'block';
                    filtered.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerText = p.name;
                        div.onclick = () => {
                            document.getElementById('search-patient').value = p.name;
                            document.getElementById('selected-patient-id').value = p.id;
                            document.getElementById('display-patient-name').innerHTML = `Paciente: <strong>${p.name}</strong>`;
                            patientSuggestions.style.display = 'none';
                        };
                        patientSuggestions.appendChild(div);
                    });
                } else patientSuggestions.style.display = 'none';
            } else patientSuggestions.style.display = 'none';
        });

        // --- MODAL DE SELEÇÃO ---
        function openSelectionModal() {
            const patientId = document.getElementById('selected-patient-id').value;
            if(!patientId) {
                alert("Selecione um paciente para iniciar o orçamento.");
                document.getElementById('search-patient').focus();
                return;
            }
            
            document.getElementById('selection-modal').style.display = 'flex';
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('modal-search').value = '';
            setTimeout(() => document.getElementById('modal-search').focus(), 100);
            renderProcedureList();
        }

        function closeSelectionModal() {
            document.getElementById('selection-modal').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function renderProcedureList() {
            const term = document.getElementById('modal-search').value.toLowerCase();
            const container = document.getElementById('modal-list-body');
            container.innerHTML = '';

            const filtered = proceduresList.filter(p => p.name.toLowerCase().includes(term));

            if(filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:2rem; color:#999;">Nenhum procedimento encontrado.</div>';
                return;
            }

            filtered.forEach(p => {
                container.innerHTML += `
                    <div class="proc-list-item" onclick="toggleCheckbox('${p.id}')">
                        <input type="checkbox" class="proc-check" id="check-${p.id}" value="${p.id}" data-name="${p.name}" data-price="${p.price}">
                        <span class="proc-name">${p.name}</span>
                        <span class="proc-price">R$ ${parseFloat(p.price).toFixed(2)}</span>
                    </div>
                `;
            });
        }

        function toggleCheckbox(id) {
            const check = document.getElementById(`check-${id}`);
            if (event.target !== check) {
                check.checked = !check.checked;
            }
        }

        function addSelectedProcedures() {
            const checkboxes = document.querySelectorAll('.proc-check:checked');
            if(checkboxes.length === 0) {
                alert("Selecione pelo menos um procedimento.");
                return;
            }

            checkboxes.forEach(chk => {
                const name = chk.getAttribute('data-name');
                const price = parseFloat(chk.getAttribute('data-price'));
                budgetItems.push({ name, tooth: '', price });
            });

            renderItems();
            closeSelectionModal();
        }

        // --- TABELA E CÁLCULOS ---
        
        function updateTooth(index, value) {
            budgetItems[index].tooth = value;
        }

        function updatePrice(index, value) {
            const val = parseFloat(value);
            if(!isNaN(val)) {
                budgetItems[index].price = val;
                calculateTotals();
            }
        }

        // Helpers visuais
        function focusPrice(el) { el.parentElement.classList.add('focused'); }
        function blurPrice(el) { el.parentElement.classList.remove('focused'); }

        function removeItem(index) {
            budgetItems.splice(index, 1);
            renderItems();
        }

        function renderItems() {
            const tbody = document.getElementById('budget-items-body');
            const emptyState = document.getElementById('empty-state');
            tbody.innerHTML = '';

            if(budgetItems.length === 0) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                budgetItems.forEach((item, index) => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.name}</td>
                            <td>
                                <div class="table-input-wrapper wrapper-center">
                                    <input type="text" class="table-input input-center" value="${item.tooth}" placeholder="-" oninput="updateTooth(${index}, this.value)" onfocus="focusPrice(this)" onblur="blurPrice(this)">
                                </div>
                            </td>
                            <td class="price-col">
                                <div class="table-input-wrapper wrapper-right">
                                    <span class="currency-symbol">R$</span>
                                    <input type="number" class="table-input input-right" value="${item.price.toFixed(2)}" step="0.01" onchange="updatePrice(${index}, this.value)" onfocus="focusPrice(this)" onblur="blurPrice(this)">
                                </div>
                            </td>
                            <td class="action-col"><button class="btn-remove" onclick="removeItem(${index})">×</button></td>
                        </tr>
                    `;
                });
            }
            calculateTotals();
        }

        function calculateTotals() {
            const subtotal = budgetItems.reduce((sum, item) => sum + item.price, 0);
            const discountVal = parseFloat(document.getElementById('discount-value').value) || 0;
            const discountType = document.getElementById('discount-type').value;
            
            let discountAmount = 0;
            if (discountVal > 0) {
                discountAmount = discountType === 'money' ? discountVal : subtotal * (discountVal / 100);
            }
            
            const total = subtotal - discountAmount;

            document.getElementById('display-subtotal').innerText = `R$ ${subtotal.toFixed(2)}`;
            document.getElementById('display-discount').innerText = `- R$ ${discountAmount.toFixed(2)}`;
            document.getElementById('display-total').innerText = `R$ ${total.toFixed(2)}`;

            const lblDiscount = document.getElementById('lbl-discount');
            const valDiscount = document.getElementById('display-discount');

            if (discountAmount > 0) {
                lblDiscount.style.display = 'inline';
                valDiscount.style.display = 'inline';
            } else {
                lblDiscount.style.display = 'none';
                valDiscount.style.display = 'none';
            }
        }

        function sendWhatsApp() {
            const patientName = document.getElementById('search-patient').value;
            const patientId = document.getElementById('selected-patient-id').value;
            if(!patientId) { alert("Selecione um paciente."); return; }
            if(budgetItems.length === 0) { alert("Adicione itens."); return; }
            
            const patient = patients.find(p => String(p.id) === String(patientId));
            let phone = patient ? patient.phone.replace(/\D/g, '') : '';
            
            let msg = `Olá *${patientName}*, segue seu orçamento Scarparo Odontologia:%0A%0A`;
            budgetItems.forEach(item => { 
                const region = item.tooth ? ` (${item.tooth})` : '';
                msg += `▪ ${item.name}${region}: R$ ${item.price.toFixed(2)}%0A`; 
            });
            
            const discountVal = parseFloat(document.getElementById('discount-value').value) || 0;
            const totalText = document.getElementById('display-total').innerText;
            
            if(discountVal > 0) {
                msg += `%0A*Total com Desconto: ${totalText}*`;
            } else {
                msg += `%0A*Total: ${totalText}*`;
            }
            
            window.open(`https://wa.me/55${phone}?text=${msg}`, '_blank');
        }
    </script>
</body>
</html>