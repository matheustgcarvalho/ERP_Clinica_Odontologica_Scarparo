<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontu√°rio Cl√≠nico</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Identidade Visual --- */
        :root {
            --color-black-rich: #121212; --color-white-bg: #F4F6F9; --color-white-pure: #FFFFFF;
            --color-gold-matte: #B9965B; --color-gold-light: #F5EFE6;
            --color-text-dark: #333333; --color-text-gray: #757575;
            --color-gray-border: #E0E0E0; --color-success: #27AE60; --color-danger: #E74C3C;
            --color-info-bg: #e0f2fe; --color-info-text: #0284c7; --color-info-border: #bae6fd;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--color-white-bg); padding: 1.5rem; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Layout e Views */
        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        /* Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-shrink: 0; }
        .page-title h2 { font-size: 1.5rem; font-weight: 600; color: var(--color-black-rich); margin: 0; }
        .page-title p { color: var(--color-text-gray); font-size: 0.9rem; margin: 0; }

        .btn-gold { background-color: var(--color-gold-matte); color: var(--color-black-rich); border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-gold:hover { background-color: #a3844a; transform: translateY(-2px); }
        .btn-secondary { background-color: #fff; border: 1px solid #ccc; color: #333; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-secondary:hover { background-color: #f0f0f0; }

        /* --- BARRA DE PESQUISA (Estilo Padr√£o) --- */
        .search-bar-container { background: var(--color-white-pure); padding: 1rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 1rem; display: flex; gap: 1rem; flex-shrink: 0; }
        .search-input { flex: 1; padding: 0.8rem; border: 1px solid var(--color-gray-border); border-radius: 6px; outline: none; font-size: 1rem;}
        .search-input:focus { border-color: var(--color-gold-matte); }

        /* --- VIEW 1: LISTA DE PRONTU√ÅRIOS ATIVOS --- */
        .chart-list-container { flex: 1; overflow-y: auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); padding: 1rem; }
        .chart-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
        .chart-item:hover { background-color: #fafafa; }
        .chart-avatar { width: 40px; height: 40px; background-color: var(--color-gold-light); color: var(--color-gold-matte); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 700; margin-right: 15px; }
        .chart-info h4 { margin: 0; color: var(--color-text-dark); }
        .chart-info p { margin: 0; font-size: 0.85rem; color: var(--color-text-gray); }
        .chart-date { font-size: 0.8rem; color: var(--color-text-gray); background: #f5f5f5; padding: 4px 8px; border-radius: 4px; }

        /* --- VIEW 2: DETALHE DO PRONTU√ÅRIO --- */
        .prontuario-layout { display: grid; grid-template-columns: 350px 1fr; gap: 1.5rem; flex: 1; overflow: hidden; }

        /* Coluna Esquerda (Controles) */
        .control-panel { background: var(--color-white-pure); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); display: flex; flex-direction: column; gap: 1rem; height: 100%; overflow-y: auto; }
        
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-label { font-size: 0.85rem; font-weight: 600; color: var(--color-text-dark); }
        .form-control { padding: 0.8rem; border: 1px solid var(--color-gray-border); border-radius: 6px; outline: none; background-color: #FAFAFA; font-size: 0.9rem; }
        .form-control:focus { border-color: var(--color-gold-matte); background: #fff; }
        
        .image-upload-box { border: 2px dashed var(--color-gray-border); border-radius: 8px; padding: 1rem; text-align: center; cursor: pointer; transition: 0.2s; background-color: #fafafa; }
        .image-upload-box:hover { border-color: var(--color-gold-matte); background-color: var(--color-gold-light); }
        .upload-preview { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
        .preview-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }

        /* Coluna Direita (Timeline) */
        .history-panel { background: var(--color-white-pure); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; position: relative; }

        .patient-header-card { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1.5rem; border-bottom: 1px solid #eee; margin-bottom: 1.5rem; }
        .patient-name-big { font-size: 1.4rem; font-weight: 700; color: var(--color-black-rich); }
        .patient-meta { color: var(--color-text-gray); font-size: 0.9rem; margin-right: 15px; display: inline-block; }
        
        .btn-anamnese-view { background-color: var(--color-info-bg); color: var(--color-info-text); border: 1px solid var(--color-info-border); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: 0.2s; }
        .btn-anamnese-view:hover { background-color: var(--color-info-border); color: #000; }

        /* Timeline */
        .timeline { position: relative; padding-left: 20px; }
        .timeline::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background-color: #eee; }
        .timeline-item { position: relative; margin-bottom: 2.5rem; }
        .timeline-dot { width: 12px; height: 12px; background-color: var(--color-gold-matte); border-radius: 50%; position: absolute; left: -25px; top: 5px; box-shadow: 0 0 0 4px white; }
        
        .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .timeline-date { font-size: 0.85rem; font-weight: 600; color: var(--color-text-gray); }
        .timeline-actions { display: flex; gap: 8px; opacity: 0.5; transition: 0.2s; }
        .timeline-item:hover .timeline-actions { opacity: 1; }
        
        .btn-icon-sm { background: none; border: none; cursor: pointer; color: #999; transition: 0.2s; padding: 2px; }
        .btn-icon-sm:hover { color: var(--color-gold-matte); transform: scale(1.1); }
        .btn-icon-sm.delete:hover { color: var(--color-danger); }

        .timeline-content { background: #fff; border: 1px solid #f0f0f0; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); white-space: pre-wrap; color: var(--color-text-dark); }
        .timeline-gallery { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .gallery-img { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 1px solid #eee; }
        .gallery-img:hover { border-color: var(--color-gold-matte); }

        /* Modais */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px); }
        .modal-box { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; color: var(--color-black-rich); }
        
        .patient-search-input { width: 100%; padding: 1rem; border: 2px solid var(--color-gray-border); border-radius: 8px; font-size: 1rem; outline: none; }
        .patient-search-input:focus { border-color: var(--color-gold-matte); }
        .search-results { margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; display: none; }
        .result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .result-item:hover { background-color: #f9f9f9; }
        
        /* Modal Anamnese (Leitura) */
        .anamnese-modal { max-width: 600px; max-height: 85vh; overflow-y: auto; }
        .ana-field { margin-bottom: 10px; }
        .ana-label { font-weight: 600; color: #555; font-size: 0.85rem; }
        .ana-value { background: #f9f9f9; padding: 8px; border-radius: 4px; color: #333; border: 1px solid #eee; }

        /* Modal Imagem Full */
        .img-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .img-viewer img { max-width: 90%; max-height: 90%; border-radius: 4px; }
        .close-viewer { position: absolute; top: 20px; right: 30px; color: white; font-size: 2rem; cursor: pointer; }

        /* Autocomplete na Side Panel */
        .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid var(--color-gray-border); border-radius: 0 0 8px 8px; z-index: 100; max-height: 150px; overflow-y: auto; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        .suggestion-item:hover { background: var(--color-gold-light); }

        .no-data { text-align: center; padding: 3rem; color: #999; }
    </style>
</head>
<body>

    <div id="overlay" class="overlay"></div>
    
    <div id="modal-new-chart" class="modal-box">
        <div class="modal-title">Iniciar Prontu√°rio</div>
        <p style="color:#777; margin-bottom:1rem;">Busque o paciente para vincular ou abrir a ficha existente.</p>
        <input type="text" id="search-patient-input" class="patient-search-input" placeholder="Nome ou CPF..." autocomplete="off">
        <div id="search-results" class="search-results"></div>
        <div style="text-align:right; margin-top:1.5rem;">
            <button class="btn-secondary" onclick="closeModal('modal-new-chart')">Cancelar</button>
        </div>
    </div>

    <div id="modal-anamnese" class="modal-box anamnese-modal">
        <div class="modal-title">Anamnese do Paciente</div>
        <div id="anamnese-content">
            </div>
        <div style="text-align:right; margin-top:1.5rem;">
            <button class="btn-gold" onclick="closeModal('modal-anamnese')">Fechar</button>
        </div>
    </div>

    <div id="img-viewer" class="img-viewer" onclick="this.style.display='none'">
        <span class="close-viewer">&times;</span>
        <img id="full-image" src="">
    </div>

    <div id="view-list" class="view-section active">
        <div class="page-header">
            <div class="page-title">
                <h2>Prontu√°rios</h2>
                <p>Hist√≥rico cl√≠nico dos pacientes ativos.</p>
            </div>
            <button class="btn-gold" onclick="openNewChartModal()">
                <svg style="width:18px; height:18px; fill:currentColor; margin-right:5px;" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Novo Prontu√°rio
            </button>
        </div>
        
        <div class="search-bar-container">
            <input type="text" id="filter-chart-input" class="search-input" placeholder="Filtrar por nome ou CPF..." onkeyup="filterChartList()">
            <button class="btn-gold">Buscar</button>
        </div>

        <div class="chart-list-container" id="chart-list">
            </div>
    </div>

    <div id="view-detail" class="view-section">
        <div class="page-header">
            <div class="page-title">
                <h2 style="font-size:1.2rem; display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="goBack()">
                    <svg style="width:24px; height:24px;" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg> 
                    Voltar para Lista
                </h2>
            </div>
        </div>

        <div class="prontuario-layout">
            <div class="control-panel">
                <h3 style="margin:0; color:var(--color-black-rich); font-size:1.1rem;">Nova Evolu√ß√£o</h3>
                <input type="hidden" id="current-patient-id">
                <input type="hidden" id="editing-record-id"> <div class="form-group">
                    <label class="form-label">Data</label>
                    <input type="date" id="rec-date" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Descri√ß√£o do Procedimento</label>
                    <textarea id="rec-text" class="form-control" rows="8" placeholder="Descreva o atendimento..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Anexos (Fotos/RX)</label>
                    <label class="image-upload-box">
                        <span style="font-size:0.8rem; color:#777;">Clique para selecionar</span>
                        <input type="file" multiple accept="image/*" style="display:none;" onchange="handleFileSelect(event)">
                    </label>
                    <div id="upload-preview" class="upload-preview"></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-secondary" id="btn-cancel-edit" style="display:none; flex:1;" onclick="cancelEdit()">Cancelar</button>
                    <button class="btn-gold" id="btn-save-record" style="flex:1; justify-content:center;" onclick="saveRecord()">Salvar Registro</button>
                </div>
            </div>

            <div class="history-panel">
                <div class="patient-header-card">
                    <div>
                        <div class="patient-name-big" id="detail-name">Nome do Paciente</div>
                        <span class="patient-meta" id="detail-cpf">CPF: 000.000.000-00</span>
                        <span class="patient-meta" id="detail-phone">Tel: (00) 00000-0000</span>
                    </div>
                    <button class="btn-anamnese-view" onclick="showAnamnesis()">
                         üìÑ Ver Anamnese
                    </button>
                </div>

                <div id="timeline-container" class="timeline"></div>
                <div id="timeline-empty" class="no-data" style="display:none;">Nenhum registro encontrado para este paciente.</div>
            </div>
        </div>
    </div>

    <script>
        // --- DADOS ---
        let patients = [], records = [], anamnesis = [];
        let currentImages = []; // Imagens tempor√°rias para upload
        
        window.onload = function() {
            loadData();
            renderChartList();
            
            // Inicializa data de hoje no form
            document.getElementById('rec-date').value = new Date().toISOString().split('T')[0];
        };

        function loadData() {
            patients = JSON.parse(localStorage.getItem('scarparo_patients')) || [];
            records = JSON.parse(localStorage.getItem('scarparo_records')) || [];
            anamnesis = JSON.parse(localStorage.getItem('scarparo_anamnesis')) || [];
        }

        // --- NAVIGATION ---
        function goBack() {
            document.getElementById('view-detail').classList.remove('active');
            document.getElementById('view-list').classList.add('active');
            renderChartList(); // Atualiza a lista ao voltar
            cancelEdit(); // Reseta formul√°rio
        }

        // --- LISTA DE PRONTU√ÅRIOS (VIEW 1) ---
        function renderChartList() {
            const container = document.getElementById('chart-list');
            container.innerHTML = '';

            // Filtra pacientes que TEM registros
            const patientsWithRecords = [...new Set(records.map(r => r.patientId))];
            
            if (patientsWithRecords.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhum prontu√°rio ativo. Clique em "Novo Prontu√°rio" para come√ßar.</div>';
                return;
            }

            patientsWithRecords.forEach(pid => {
                const p = patients.find(pat => String(pat.id) === String(pid));
                if (p) {
                    // Pega a data do √∫ltimo registro
                    const pRecords = records.filter(r => String(r.patientId) === String(pid));
                    pRecords.sort((a,b) => new Date(b.date) - new Date(a.date));
                    const lastVisit = pRecords[0].date.split('-').reverse().join('/');

                    const div = document.createElement('div');
                    div.className = 'chart-item';
                    div.setAttribute('data-name', p.name.toLowerCase()); // Auxiliar para busca
                    div.setAttribute('data-cpf', p.cpf.replace(/\D/g, '')); // Auxiliar para busca
                    
                    div.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <div class="chart-avatar">${p.name.charAt(0)}</div>
                            <div class="chart-info">
                                <h4>${p.name}</h4>
                                <p>CPF: ${p.cpf}</p>
                            </div>
                        </div>
                        <div class="chart-date">√öltima: ${lastVisit}</div>
                    `;
                    div.onclick = () => openPatientChart(p.id);
                    container.appendChild(div);
                }
            });
        }

        // --- FUN√á√ÉO DE BUSCA NA LISTA (NOVA) ---
        function filterChartList() {
            const term = document.getElementById('filter-chart-input').value.toLowerCase().replace(/\D/g, ''); // Normaliza removendo caracteres especiais se for CPF
            const textTerm = document.getElementById('filter-chart-input').value.toLowerCase(); // Para busca por nome
            
            const items = document.querySelectorAll('.chart-item');
            
            items.forEach(item => {
                const name = item.getAttribute('data-name');
                const cpf = item.getAttribute('data-cpf');
                
                if (name.includes(textTerm) || cpf.includes(term)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // --- MODAL: NOVO PRONTU√ÅRIO ---
        function openNewChartModal() {
            document.getElementById('modal-new-chart').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('search-patient-input').value = '';
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('search-patient-input').focus();
        }

        // Busca de paciente no modal
        document.getElementById('search-patient-input').addEventListener('input', function() {
            const term = this.value.toLowerCase();
            const resBox = document.getElementById('search-results');
            resBox.innerHTML = '';
            
            if(term.length > 0) {
                const filtered = patients.filter(p => p.name.toLowerCase().includes(term) || p.cpf.includes(term));
                if(filtered.length > 0) {
                    resBox.style.display = 'block';
                    filtered.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'result-item';
                        div.innerText = `${p.name} (${p.cpf})`;
                        div.onclick = () => selectPatientForChart(p.id);
                        resBox.appendChild(div);
                    });
                } else { resBox.style.display = 'none'; }
            } else { resBox.style.display = 'none'; }
        });

        function selectPatientForChart(pid) {
            closeModal('modal-new-chart');
            openPatientChart(pid);
        }

        // --- DETALHE DO PRONTU√ÅRIO (VIEW 2) ---
        function openPatientChart(pid) {
            const p = patients.find(pat => String(pat.id) === String(pid));
            if(!p) return;

            // Preenche Header
            document.getElementById('detail-name').innerText = p.name;
            document.getElementById('detail-cpf').innerText = `CPF: ${p.cpf}`;
            document.getElementById('detail-phone').innerText = `Tel: ${p.phone}`;
            document.getElementById('current-patient-id').value = pid;

            // Alterna Views
            document.getElementById('view-list').classList.remove('active');
            document.getElementById('view-detail').classList.add('active');

            renderTimeline(pid);
        }

        function renderTimeline(pid) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';
            
            const pRecords = records.filter(r => String(r.patientId) === String(pid));
            
            if(pRecords.length === 0) {
                document.getElementById('timeline-empty').style.display = 'block';
            } else {
                document.getElementById('timeline-empty').style.display = 'none';
                // Ordena por data decrescente
                pRecords.sort((a,b) => new Date(b.date) - new Date(a.date));

                pRecords.forEach(rec => {
                    const dateParts = rec.date.split('-');
                    const dateFmt = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                    
                    let imgsHtml = '';
                    if(rec.images && rec.images.length > 0) {
                        imgsHtml = '<div class="timeline-gallery">';
                        rec.images.forEach(src => {
                            imgsHtml += `<img src="${src}" class="gallery-img" onclick="viewImage('${src}')">`;
                        });
                        imgsHtml += '</div>';
                    }

                    const html = `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-header">
                            <span class="timeline-date">${dateFmt}</span>
                            <div class="timeline-actions">
                                <button class="btn-icon-sm" title="Editar" onclick="editRecord('${rec.id}')">‚úé</button>
                                <button class="btn-icon-sm delete" title="Excluir" onclick="deleteRecord('${rec.id}')">üóë</button>
                            </div>
                        </div>
                        <div class="timeline-content">
                            <div>${rec.text.replace(/\n/g, '<br>')}</div>
                            ${imgsHtml}
                        </div>
                    </div>`;
                    container.innerHTML += html;
                });
            }
        }

        // --- CRUD REGISTROS ---
        function handleFileSelect(e) {
            const files = e.target.files;
            const previewBox = document.getElementById('upload-preview');
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    currentImages.push(evt.target.result);
                    const img = document.createElement('img');
                    img.src = evt.target.result;
                    img.className = 'preview-img';
                    previewBox.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        function saveRecord() {
            const pid = document.getElementById('current-patient-id').value;
            const date = document.getElementById('rec-date').value;
            const text = document.getElementById('rec-text').value;
            const editId = document.getElementById('editing-record-id').value;

            if(!date || !text) { alert("Preencha a data e a descri√ß√£o."); return; }

            if (editId) {
                const idx = records.findIndex(r => String(r.id) === String(editId));
                if(idx > -1) {
                    records[idx].date = date;
                    records[idx].text = text;
                    if(currentImages.length > 0) records[idx].images = [...records[idx].images, ...currentImages];
                }
            } else {
                const newRec = {
                    id: String(Date.now()),
                    patientId: pid,
                    date: date,
                    text: text,
                    images: [...currentImages]
                };
                records.push(newRec);
            }

            localStorage.setItem('scarparo_records', JSON.stringify(records));
            cancelEdit(); 
            renderTimeline(pid);
        }

        function editRecord(id) {
            const rec = records.find(r => String(r.id) === String(id));
            if(!rec) return;

            document.getElementById('rec-date').value = rec.date;
            document.getElementById('rec-text').value = rec.text;
            document.getElementById('editing-record-id').value = rec.id;
            
            document.getElementById('btn-save-record').innerText = "Atualizar";
            document.getElementById('btn-cancel-edit').style.display = 'block';
            
            const previewBox = document.getElementById('upload-preview');
            previewBox.innerHTML = '';
            currentImages = []; 
            if(rec.images) {
                rec.images.forEach(src => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.className = 'preview-img';
                    previewBox.appendChild(img);
                });
            }
            
            document.querySelector('.control-panel').scrollTop = 0;
        }

        function deleteRecord(id) {
            if(confirm("Tem certeza que deseja excluir este registro?")) {
                records = records.filter(r => String(r.id) !== String(id));
                localStorage.setItem('scarparo_records', JSON.stringify(records));
                renderTimeline(document.getElementById('current-patient-id').value);
            }
        }

        function cancelEdit() {
            document.getElementById('rec-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('rec-text').value = '';
            document.getElementById('editing-record-id').value = '';
            document.getElementById('upload-preview').innerHTML = '';
            currentImages = [];
            document.getElementById('btn-save-record').innerText = "Salvar Evolu√ß√£o";
            document.getElementById('btn-cancel-edit').style.display = 'none';
        }

        // --- ANAMNESE ---
        function showAnamnesis() {
            const pid = document.getElementById('current-patient-id').value;
            const ana = anamnesis.find(a => String(a.patientId) === String(pid));
            
            const content = document.getElementById('anamnese-content');
            content.innerHTML = '';

            if(!ana) {
                content.innerHTML = '<p style="color:#999; text-align:center;">Nenhuma ficha de anamnese preenchida para este paciente.</p>';
            } else {
                let checksHtml = '<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:1rem;">';
                for (const [key, val] of Object.entries(ana.checks)) {
                    if(val) {
                        const label = key.replace('ana-', '').charAt(0).toUpperCase() + key.replace('ana-', '').slice(1);
                        checksHtml += `<span style="background:#f9f9f9; padding:5px; border-radius:4px; font-size:0.85rem;">‚úÖ ${label}</span>`;
                    }
                }
                checksHtml += '</div>';

                content.innerHTML = `
                    <div class="ana-field"><div class="ana-label">Queixa Principal</div><div class="ana-value">${ana.queixa || '-'}</div></div>
                    <div class="ana-label" style="margin-bottom:5px;">Hist√≥rico de Sa√∫de</div>
                    ${checksHtml}
                    <div class="ana-field"><div class="ana-label">Alergias</div><div class="ana-value">${ana.alergiasDesc || '-'}</div></div>
                    <div class="ana-field"><div class="ana-label">Medicamentos</div><div class="ana-value">${ana.medicamentos || '-'}</div></div>
                `;
            }

            document.getElementById('modal-anamnese').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
        function viewImage(src) {
            document.getElementById('full-image').src = src;
            document.getElementById('img-viewer').style.display = 'flex';
        }
    </script>
</body>
</html>