<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontuário Clínico</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-black-rich: #121212; --color-white-bg: #F4F6F9; --color-white-pure: #FFFFFF;
            --color-gold-matte: #B9965B; --color-gold-light: #F5EFE6;
            --color-text-dark: #333333; --color-text-gray: #757575;
            --color-gray-border: #E0E0E0; --color-success: #27AE60; --color-danger: #E74C3C;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--color-white-bg); padding: 1.5rem; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-shrink: 0; }
        .page-title h2 { font-size: 1.5rem; font-weight: 600; color: var(--color-black-rich); margin: 0; }
        .page-title p { color: var(--color-text-gray); font-size: 0.9rem; margin: 0; }

        .btn-gold { background-color: var(--color-gold-matte); color: var(--color-black-rich); border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn-gold:hover { background-color: #a3844a; transform: translateY(-2px); }

        /* Layout Split */
        .prontuario-layout { display: grid; grid-template-columns: 350px 1fr; gap: 1.5rem; flex: 1; overflow: hidden; }

        /* Coluna Esquerda: Seleção e Novo Registro */
        .control-panel { background: var(--color-white-pure); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); display: flex; flex-direction: column; gap: 1.5rem; height: 100%; overflow-y: auto; }
        
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; position: relative; }
        .form-label { font-size: 0.85rem; font-weight: 600; color: var(--color-text-dark); }
        .form-control { padding: 0.8rem; border: 1px solid var(--color-gray-border); border-radius: 6px; outline: none; background-color: #FAFAFA; font-size: 0.9rem; font-family: inherit; }
        .form-control:focus { border-color: var(--color-gold-matte); background: #fff; }
        
        /* Autocomplete */
        .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid var(--color-gray-border); border-radius: 0 0 8px 8px; z-index: 100; max-height: 150px; overflow-y: auto; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        .suggestion-item:hover { background: var(--color-gold-light); }

        /* Área de Upload de Imagem */
        .image-upload-box {
            border: 2px dashed var(--color-gray-border);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            background-color: #fafafa;
        }
        .image-upload-box:hover { border-color: var(--color-gold-matte); background-color: var(--color-gold-light); }
        .upload-preview { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
        .preview-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }

        /* Coluna Direita: Timeline */
        .history-panel { 
            background: var(--color-white-pure); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); 
            padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; 
            position: relative;
        }

        /* Patient Header no topo da timeline */
        .patient-header-card {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 1.5rem; border-bottom: 1px solid #eee; margin-bottom: 1.5rem;
        }
        .patient-name-big { font-size: 1.4rem; font-weight: 700; color: var(--color-black-rich); }
        .patient-meta { color: var(--color-text-gray); font-size: 0.9rem; }

        /* Timeline Style */
        .timeline { position: relative; padding-left: 20px; }
        .timeline::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background-color: #eee;
        }
        .timeline-item { position: relative; margin-bottom: 2.5rem; }
        .timeline-dot {
            width: 12px; height: 12px; background-color: var(--color-gold-matte); 
            border-radius: 50%; position: absolute; left: -25px; top: 5px; 
            box-shadow: 0 0 0 4px white;
        }
        .timeline-date { font-size: 0.85rem; font-weight: 600; color: var(--color-text-gray); margin-bottom: 0.5rem; }
        .timeline-content { 
            background: #fff; border: 1px solid #f0f0f0; padding: 1rem; border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); 
        }
        .timeline-text { color: var(--color-text-dark); line-height: 1.5; white-space: pre-wrap; }
        
        .timeline-gallery { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .gallery-img { 
            width: 80px; height: 80px; object-fit: cover; border-radius: 6px; 
            cursor: pointer; transition: 0.2s; border: 1px solid #eee;
        }
        .gallery-img:hover { transform: scale(1.05); border-color: var(--color-gold-matte); }

        .empty-state { text-align: center; color: #999; margin-top: 3rem; }
        
        /* Modal de Imagem Full */
        .img-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;
        }
        .img-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .close-img { position: absolute; top: 20px; right: 30px; color: white; font-size: 2rem; cursor: pointer; }
    </style>
</head>
<body>

    <div id="img-viewer" class="img-modal" onclick="this.style.display='none'">
        <span class="close-img">&times;</span>
        <img id="full-image" src="">
    </div>

    <div class="page-header">
        <div class="page-title">
            <h2>Prontuário</h2>
            <p>Histórico clínico e evoluções.</p>
        </div>
    </div>

    <div class="prontuario-layout">
        
        <div class="control-panel">
            <div class="form-group">
                <label class="form-label">Selecionar Paciente</label>
                <input type="text" id="search-patient" class="form-control" placeholder="Digite o nome..." autocomplete="off">
                <div id="patient-suggestions" class="suggestions-box"></div>
                <input type="hidden" id="selected-patient-id">
            </div>

            <hr style="border:0; border-top:1px solid #eee;">

            <div id="new-record-box" style="display:none; flex-direction: column; gap: 1rem;">
                <h4 style="color: var(--color-black-rich);">Nova Evolução</h4>
                
                <div class="form-group">
                    <label class="form-label">Data</label>
                    <input type="date" id="rec-date" class="form-control">
                </div>

                <div class="form-group">
                    <label class="form-label">Descrição do Procedimento</label>
                    <textarea id="rec-text" class="form-control" rows="6" placeholder="Descreva o procedimento realizado, dentes envolvidos, materiais, etc."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Fotos / Raios-X</label>
                    <label for="rec-files" class="image-upload-box">
                        <span style="font-size:0.8rem; color:#777;">Clique para adicionar imagens</span>
                        <input type="file" id="rec-files" multiple accept="image/*" style="display:none;" onchange="handleFileSelect(event)">
                    </label>
                    <div id="upload-preview" class="upload-preview"></div>
                </div>

                <button class="btn-gold" style="justify-content: center; margin-top: 10px;" onclick="saveRecord()">
                    Salvar Evolução
                </button>
            </div>

            <div id="select-msg" style="text-align:center; color:#999; margin-top:2rem;">
                Selecione um paciente para adicionar registros.
            </div>
        </div>

        <div class="history-panel">
            <div id="patient-header" class="patient-header-card" style="display:none;">
                <div>
                    <div class="patient-name-big" id="p-name-display">Nome do Paciente</div>
                    <div class="patient-meta" id="p-cpf-display">CPF: 000.000.000-00</div>
                </div>
                <button class="btn-gold" style="background:#eee; color:#333;" onclick="printHistory()">Imprimir</button>
            </div>

            <div id="timeline-container" class="timeline">
                </div>
            
            <div id="history-empty" class="empty-state">
                Selecione um paciente para visualizar o histórico.
            </div>
        </div>
    </div>

    <script>
        let patients = JSON.parse(localStorage.getItem('scarparo_patients')) || [];
        let records = JSON.parse(localStorage.getItem('scarparo_records')) || [];
        let currentImages = []; // Array de base64 temporário

        // --- BUSCA DE PACIENTE ---
        const searchInput = document.getElementById('search-patient');
        const suggestions = document.getElementById('patient-suggestions');

        searchInput.addEventListener('input', function() {
            const term = this.value.toLowerCase();
            suggestions.innerHTML = '';
            if(term.length > 0) {
                const filtered = patients.filter(p => p.name.toLowerCase().includes(term));
                if(filtered.length > 0) {
                    suggestions.style.display = 'block';
                    filtered.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerText = p.name;
                        div.onclick = () => loadPatient(p);
                        suggestions.appendChild(div);
                    });
                } else suggestions.style.display = 'none';
            } else suggestions.style.display = 'none';
        });

        // --- CARREGAR PACIENTE ---
        function loadPatient(p) {
            document.getElementById('selected-patient-id').value = p.id;
            document.getElementById('search-patient').value = p.name;
            suggestions.style.display = 'none';

            // Show Forms
            document.getElementById('new-record-box').style.display = 'flex';
            document.getElementById('select-msg').style.display = 'none';
            
            // Show Header
            document.getElementById('patient-header').style.display = 'flex';
            document.getElementById('p-name-display').innerText = p.name;
            document.getElementById('p-cpf-display').innerText = `CPF: ${p.cpf}`;

            // Set Date Today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rec-date').value = today;

            renderHistory(p.id);
        }

        // --- RENDERIZAR HISTÓRICO ---
        function renderHistory(pid) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';
            
            const patientRecords = records.filter(r => String(r.patientId) === String(pid));
            
            if(patientRecords.length === 0) {
                document.getElementById('history-empty').innerText = "Nenhum registro clínico encontrado para este paciente.";
                document.getElementById('history-empty').style.display = 'block';
            } else {
                document.getElementById('history-empty').style.display = 'none';
                
                // Order by date desc
                patientRecords.sort((a,b) => new Date(b.date) - new Date(a.date));

                patientRecords.forEach(rec => {
                    // Format Date
                    const dateParts = rec.date.split('-');
                    const dateFormatted = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;

                    let imagesHtml = '';
                    if(rec.images && rec.images.length > 0) {
                        imagesHtml = '<div class="timeline-gallery">';
                        rec.images.forEach(img => {
                            imagesHtml += `<img src="${img}" class="gallery-img" onclick="openImage('${img}')">`;
                        });
                        imagesHtml += '</div>';
                    }

                    const item = `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-date">${dateFormatted}</div>
                        <div class="timeline-content">
                            <div class="timeline-text">${rec.text}</div>
                            ${imagesHtml}
                        </div>
                    </div>`;
                    container.innerHTML += item;
                });
            }
        }

        // --- UPLOAD DE IMAGENS (PREVIEW) ---
        function handleFileSelect(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('upload-preview');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    currentImages.push(base64); // Add to temp array
                    
                    const img = document.createElement('img');
                    img.src = base64;
                    img.className = 'preview-img';
                    previewContainer.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        }

        // --- SALVAR EVOLUÇÃO ---
        function saveRecord() {
            const pid = document.getElementById('selected-patient-id').value;
            const date = document.getElementById('rec-date').value;
            const text = document.getElementById('rec-text').value;

            if(!pid || !date || !text) {
                alert("Preencha a data e a descrição.");
                return;
            }

            const newRecord = {
                id: String(Date.now()),
                patientId: pid,
                date: date,
                text: text,
                images: [...currentImages] // Clone array
            };

            records.push(newRecord);
            localStorage.setItem('scarparo_records', JSON.stringify(records));

            // Reset Form
            document.getElementById('rec-text').value = '';
            document.getElementById('rec-files').value = '';
            document.getElementById('upload-preview').innerHTML = '';
            currentImages = [];

            renderHistory(pid);
        }

        // --- VISUALIZADOR DE IMAGEM ---
        function openImage(src) {
            document.getElementById('full-image').src = src;
            document.getElementById('img-viewer').style.display = 'flex';
        }

        function printHistory() {
            window.print();
        }
    </script>
</body>
</html>